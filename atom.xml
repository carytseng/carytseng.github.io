<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CaryTseng</title>
  <icon>https://www.gravatar.com/avatar/bac9080800c06a1b685d5f013601b128</icon>
  <subtitle>大道至简，实干为要</subtitle>
  <link href="https://dogfun.top/atom.xml" rel="self"/>
  
  <link href="https://dogfun.top/"/>
  <updated>2022-02-23T02:03:49.467Z</updated>
  <id>https://dogfun.top/</id>
  
  <author>
    <name>CaryTseng</name>
    <email>carytseng.kira@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>k8s</title>
    <link href="https://dogfun.top/2022/02/22/%E5%AE%B9%E5%99%A8/k8/"/>
    <id>https://dogfun.top/2022/02/22/%E5%AE%B9%E5%99%A8/k8/</id>
    <published>2022-02-22T03:24:58.000Z</published>
    <updated>2022-02-23T02:03:49.467Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><img src="https://img.orchome.com/group1/M00/00/03/dr5oXFv0K4eAMuaUAACvvKRWv6A962.png" alt="Pod、RC与Service的关系"></p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>​    一类服务，有name，虚拟ip和port，提供远程能力</p><pre><code>#### 三种IP</code></pre><ul><li>Node IP：Node节点的IP地址，真实的物理机网卡的ip地址。</li><li>Pod IP：Pod的IP地址，docker0网桥分配的ip。</li><li>Cluster IP：Service的IP地址，虚拟的ip，无法ping，由Kubernetes管理分配。</li></ul><p>外部系统访问Service的方式，通过NodePort暴露出来</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>​    以<em>Pod</em>为最小单位来调度并管理<em>Docker</em>容器<em>（Container）</em>，其中1个<em>Pod</em>可含多个容器，且相同<em>Pod</em>里的容器共享本地网络，容器间可通过<em>localhost</em>地址互访，即容器如同部署在相同的主机上，而以<em>Pod</em>为最小单元来调度则表明：<em>Pod</em>内的容器被调度到相同的<em>Docker</em>节点上。</p><p>Service于Pod的关系，即可理解为Pod是Service一类服务定义的运行实例</p><h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>​    将应用直接以<em>Pod</em>形式部署很少见，主因是：<em>Pod</em>无法提供弹性伸缩，且节点故障时<em>K8S</em>无法将其调度到幸存节点上，缺少自愈能力。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy -o wide</span><br></pre></td></tr></table></figure><h2 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h2><p>​    Pod是服务实例运行的最小单元（pause容器+业务容器），Service用来暴露服务，通过label来负载均衡到pod集群上，RC保证service的服务能力，根据情况进行调度与监控。每个Service分配一个ClusterIP，属于Kubernetes集群内的虚拟ip，pod的地址会随着伸缩而变化注册到service，但service是不变的，类似注册中心的作用。Deployment用来定义服务的，定义副本数量</p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"># 创建pod</span><br><span class="line">kubectl create -f /tmp/myhttpd.pod </span><br><span class="line"></span><br><span class="line"># 查看pod</span><br><span class="line">kubectl get pod</span><br><span class="line"></span><br><span class="line"># 查看pod的ip</span><br><span class="line">kubectl describe pod myhttp|grep IP</span><br><span class="line"></span><br><span class="line"># 集群所有node</span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"># 节点详情</span><br><span class="line">kubectl describe node 127.0.0.1</span><br><span class="line"></span><br><span class="line"># 获取所有部署</span><br><span class="line">kubectl get deployments</span><br><span class="line"></span><br><span class="line"># 查看所有 pod 列表,  -n 后跟 namespace, 查看指定的命名空间</span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl get pod -n kube  </span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看 RC 和 service 列表， -o wide 查看详细信息</span><br><span class="line">kubectl get rc,svc</span><br><span class="line">kubectl get pod,svc -o wide  </span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 显示 Node 的详细信息</span><br><span class="line">kubectl describe node 192.168.0.212</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 显示 Pod 的详细信息, 特别是查看 pod 无法创建的时候的日志</span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line">eg:</span><br><span class="line">kubectl describe pod redis-master-tqds9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 根据 yaml 创建资源, apply 可以重复执行，create 不行</span><br><span class="line">kubectl create -f pod.yaml</span><br><span class="line">kubectl apply -f pod.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 基于 pod.yaml 定义的名称删除 pod </span><br><span class="line">kubectl delete -f pod.yaml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 删除所有包含某个 label 的pod 和 service</span><br><span class="line">kubectl delete pod,svc -l name=&lt;label-name&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 删除所有 Pod</span><br><span class="line">kubectl delete pod --all</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看 endpoint 列表</span><br><span class="line">kubectl get endpoints</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 执行 pod 的 date 命令</span><br><span class="line">kubectl exec &lt;pod-name&gt; -- date</span><br><span class="line">kubectl exec &lt;pod-name&gt; -- bash</span><br><span class="line">kubectl exec &lt;pod-name&gt; -- ping 10.24.51.9</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 通过bash获得 pod 中某个容器的TTY，相当于登录容器</span><br><span class="line">kubectl exec -it &lt;pod-name&gt; -c &lt;container-name&gt; -- bash</span><br><span class="line">eg:</span><br><span class="line">kubectl exec -it redis-master-cln81 -- bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看容器的日志</span><br><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line">kubectl logs -f &lt;pod-name&gt; # 实时查看日志</span><br><span class="line">kubectl log  &lt;pod-name&gt;  -c &lt;container_name&gt; # 若 pod 只有一个容器，可以不加 -c </span><br><span class="line"></span><br><span class="line">kubectl logs -l app=frontend # 返回所有标记为 app=frontend 的 pod 的合并日志。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看注释</span><br><span class="line">kubectl explain pod</span><br><span class="line">kubectl explain pod.apiVersion</span><br><span class="line"></span><br><span class="line"># 查看节点 labels</span><br><span class="line">kubectl get node --show-labels</span><br><span class="line"></span><br><span class="line"># 重启 pod</span><br><span class="line">kubectl get pod &lt;POD名称&gt; -n &lt;NAMESPACE名称&gt; -o yaml | kubectl replace --force -f -</span><br><span class="line"></span><br><span class="line"># 修改网络类型</span><br><span class="line">kubectl patch service istio-ingressgateway -n istio-system -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line"># 伸缩 pod 副本</span><br><span class="line"># 可用于将Deployment及其Pod缩小为零个副本，实际上杀死了所有副本。当您将其缩放回1/1时，将创建一个新的Pod，重新启动您的应用程序。</span><br><span class="line">kubectl scale deploy/nginx-1 --replicas=0</span><br><span class="line">kubectl scale deploy/nginx-1 --replicas=1</span><br><span class="line"></span><br><span class="line"># 查看前一个 pod 的日志，logs -p 选项 </span><br><span class="line">kubectl logs --tail 100 -p user-klvchen-v1.0-6f67dcc46b-5b4qb &gt; pre.log</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://img.orchome.com/group1/M00/00/03/dr5oXFv0K4eAMuaUAAC</summary>
      
    
    
    
    <category term="容器" scheme="https://dogfun.top/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>随想2-20</title>
    <link href="https://dogfun.top/2022/02/20/%E9%9A%8F%E6%83%B3/%E9%9A%8F%E6%83%B32-20/"/>
    <id>https://dogfun.top/2022/02/20/%E9%9A%8F%E6%83%B3/%E9%9A%8F%E6%83%B32-20/</id>
    <published>2022-02-20T09:58:09.000Z</published>
    <updated>2022-02-20T10:00:24.444Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>渴望倾诉，也渴望独处，人就是矛盾二元对立的结合体。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;渴望倾诉，也渴望独处，人就是矛盾二元对立的结合体。&lt;/p&gt;
&lt;/blockquote&gt;
</summary>
      
    
    
    
    <category term="随想" scheme="https://dogfun.top/categories/%E9%9A%8F%E6%83%B3/"/>
    
    
  </entry>
  
  <entry>
    <title>helm</title>
    <link href="https://dogfun.top/2022/02/20/%E5%AE%B9%E5%99%A8/helm/"/>
    <id>https://dogfun.top/2022/02/20/%E5%AE%B9%E5%99%A8/helm/</id>
    <published>2022-02-20T02:14:13.000Z</published>
    <updated>2022-02-20T10:50:12.422Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>Helm是k8s的包管理工具，使用helm可以简化k8s应用部署</p><ul><li><strong>Chart</strong>：一个 Helm 包，其中包含了运行一个应用所需要的镜像、依赖和资源定义等，还可能包含 Kubernetes 集群中的服务定义。</li><li><strong>Release</strong>：在 Kubernetes 集群上运行的 Chart 的一个实例。在同一个集群上，一个 Chart 可以安装很多次。每次安装都会创建一个新的 release。例如一个 MySQL Chart，如果想在服务器上运行两个数据库，就可以把这个 Chart 安装两次。每次安装都会生成自己的 Release，会有自己的 Release 名称。</li><li><strong>Repository</strong>：用于发布和存储 Chart 的存储库。</li></ul><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><img src="https://img2018.cnblogs.com/i-beta/1356274/202001/1356274-20200104133425850-1349135834.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">myapp                                   - chart 包目录名</span><br><span class="line">├── charts                              - 依赖的子包目录，里面可以包含多个依赖的chart包</span><br><span class="line">├── Chart.yaml                          - chart定义，可以定义chart的名字，版本号信息。</span><br><span class="line">├── templates                           - k8s配置模版目录， 我们编写的k8s配置都在这个目录， 除了NOTES.txt和下划线开头命名的文件，其他文件可以随意命名。</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl                    - 下划线开头的文件，helm视为公共库定义文件，主要用于定义通用的子模版、函数等，helm不会将这些公共库文件的渲染结果提交给k8s处理。</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt                       - chart包的帮助信息文件，执行helm install命令安装成功后会输出这个文件的内容。</span><br><span class="line">│   └── service.yaml</span><br><span class="line">└── values.yaml                         - chart包的参数配置文件，模版可以引用这里参数。</span><br></pre></td></tr></table></figure><h2 id="添加本地仓库"><a href="#添加本地仓库" class="headerlink" title="添加本地仓库"></a>添加本地仓库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -e DEBUG=1 \</span><br><span class="line">  -e STORAGE=local \</span><br><span class="line">  -e STORAGE_LOCAL_ROOTDIR=/charts \</span><br><span class="line">  -v /opt/charts:/charts \</span><br><span class="line">  chartmuseum/chartmuseum:latest</span><br><span class="line">  </span><br><span class="line">helm repo add localrepo http://192.168.2.19:8080</span><br></pre></td></tr></table></figure><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 创建chart包</span><br><span class="line">helm create mychart</span><br><span class="line"></span><br><span class="line"># 验证文件合法性</span><br><span class="line">helm lint</span><br><span class="line"></span><br><span class="line"># 测试生成</span><br><span class="line">helm install web --dry-run demo/</span><br><span class="line"></span><br><span class="line"># 正式生成: helm install  --set key=value   chart包目录</span><br><span class="line">helm install local/web </span><br><span class="line"></span><br><span class="line"># 打包</span><br><span class="line">helm package mychart [--debug]</span><br><span class="line"></span><br><span class="line"># 本地仓库查找</span><br><span class="line">helm search repo mychart</span><br><span class="line">helm search</span><br><span class="line"></span><br><span class="line">从远程仓库查找:helm search hub [chart]</span><br><span class="line"></span><br><span class="line">helm repo list </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#命令格式: helm upgrade release名字  chart包目录</span><br><span class="line">helm upgrade myapp ./myapp</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h2&gt;&lt;p&gt;Helm是k8s的包管理工具，使用helm可以简化k8s应用部署&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Chart&lt;/strong&gt;：一</summary>
      
    
    
    
    <category term="容器" scheme="https://dogfun.top/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>javacv抓取rtsp视频流</title>
    <link href="https://dogfun.top/2022/02/20/web/javacv%E6%8A%93%E5%8F%96rtsp%E8%A7%86%E9%A2%91%E6%B5%81/"/>
    <id>https://dogfun.top/2022/02/20/web/javacv%E6%8A%93%E5%8F%96rtsp%E8%A7%86%E9%A2%91%E6%B5%81/</id>
    <published>2022-02-20T01:19:22.000Z</published>
    <updated>2022-02-20T01:17:28.233Z</updated>
    
    <content type="html"><![CDATA[<h3 id="javacv"><a href="#javacv" class="headerlink" title="javacv"></a>javacv</h3><blockquote><p>java平台的流媒体开发包，对opencv、ffmpeg等库做了二次封装</p></blockquote><h3 id="流媒体协议"><a href="#流媒体协议" class="headerlink" title="流媒体协议"></a>流媒体协议</h3><blockquote><p>rtmp、rtsp、hls</p></blockquote><h3 id="封装格式"><a href="#封装格式" class="headerlink" title="封装格式"></a>封装格式</h3><blockquote><p>flv、jpeg、png</p></blockquote><h3 id="图像像素格式"><a href="#图像像素格式" class="headerlink" title="图像像素格式"></a>图像像素格式</h3><blockquote><p>没有经过编码的原始像素排列的数据</p></blockquote><h3 id="图片封装格式"><a href="#图片封装格式" class="headerlink" title="图片封装格式"></a>图片封装格式</h3><blockquote><p>png（无损）、bmp（无损不压缩）、gif/jpg（有损压缩）</p></blockquote><h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><blockquote><p>对图像像素格式进行编码才是视频帧，即压缩</p></blockquote><h1 id="FrameGrabber-帧抓取器-采集器-介绍"><a href="#FrameGrabber-帧抓取器-采集器-介绍" class="headerlink" title="FrameGrabber(帧抓取器/采集器)介绍"></a>FrameGrabber(帧抓取器/采集器)介绍</h1><p>用于采集/抓取视频图像和音频采样。封装了检索流信息，自动猜测视频解码格式，音视频解码等具体API，并把解码完的像素数据（可配置像素格式）或音频数据保存到Frame中返回等功</p><p><strong>FrameGrabber</strong>的子类/实现类包含以下几个：</p><p><strong>FFmpegFrameGrabber、OpenCVFrameGrabber、IPCameraFrameGrabber、VideoInputFrameGrabber、FlyCapture2FrameGrabber、DC1394FrameGrabber</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;javacv&quot;&gt;&lt;a href=&quot;#javacv&quot; class=&quot;headerlink&quot; title=&quot;javacv&quot;&gt;&lt;/a&gt;javacv&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;java平台的流媒体开发包，对opencv、ffmpeg等库做了二次封装&lt;/p&gt;
</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
    <category term="技术学习" scheme="https://dogfun.top/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>剑指 Offer 09. 用两个栈实现队列</title>
    <link href="https://dogfun.top/2022/02/20/%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer%2009.%20%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/"/>
    <id>https://dogfun.top/2022/02/20/%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer%2009.%20%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/</id>
    <published>2022-02-20T01:19:22.000Z</published>
    <updated>2022-02-20T01:30:32.612Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class CQueue &#123;</span><br><span class="line"></span><br><span class="line">  Stack&lt;Integer&gt; s1;</span><br><span class="line">  Stack&lt;Integer&gt; s2;</span><br><span class="line"></span><br><span class="line">  public CQueue() &#123;</span><br><span class="line">    s1 = new Stack();</span><br><span class="line">    s2 = new Stack();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public void appendTail(int value) &#123;</span><br><span class="line">    while (s2.size() &gt; 0) &#123;</span><br><span class="line">      s1.push(s2.pop());</span><br><span class="line">    &#125;</span><br><span class="line">    s1.push(value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public int deleteHead() &#123;</span><br><span class="line">    while (s1.size() &gt; 0) &#123;</span><br><span class="line">      s2.push(s1.pop());</span><br><span class="line">    &#125;</span><br><span class="line">    return s2.size() == 0 ? -1 : s2.pop();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"></span><br><span class="line"> * Your CQueue object will be instantiated and called as such:</span><br><span class="line"> * CQueue obj = new CQueue();</span><br><span class="line"> * obj.appendTail(value);</span><br><span class="line"> * int param_2 = obj.deleteHead();</span><br><span class="line">   */</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span c</summary>
      
    
    
    
    <category term="算法" scheme="https://dogfun.top/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="技术学习" scheme="https://dogfun.top/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>剑指 Offer 10- I. 斐波那契数列</title>
    <link href="https://dogfun.top/2022/02/20/%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer%2010-%20I.%20%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/"/>
    <id>https://dogfun.top/2022/02/20/%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer%2010-%20I.%20%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/</id>
    <published>2022-02-20T01:19:22.000Z</published>
    <updated>2022-02-20T01:30:47.415Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class Solution &#123;</span><br><span class="line"></span><br><span class="line">  public int fib(int n) &#123;</span><br><span class="line">    if (n == 0 || n == 1) &#123;</span><br><span class="line">      return n;</span><br><span class="line">    &#125;</span><br><span class="line">    int a = 1, b = 0;</span><br><span class="line">    for (i = 1; i &lt; n; i++) &#123;</span><br><span class="line">      a = a + b;</span><br><span class="line">      b = a - b;</span><br><span class="line">      a %= 1000000007;</span><br><span class="line">    &#125;</span><br><span class="line">    return a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span c</summary>
      
    
    
    
    <category term="算法" scheme="https://dogfun.top/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="技术学习" scheme="https://dogfun.top/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>跨域CORS后端处理</title>
    <link href="https://dogfun.top/2021/11/29/web/CORS/"/>
    <id>https://dogfun.top/2021/11/29/web/CORS/</id>
    <published>2021-11-29T07:15:50.000Z</published>
    <updated>2021-11-29T08:54:32.423Z</updated>
    
    <content type="html"><![CDATA[<h2 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h2><pre><code>    浏览器自身存在保护机制，当从一个域名访问另一个域名的资源时，域名、端口、协议任一不同，都会产生跨域问题</code></pre><h2 id="跨域限制"><a href="#跨域限制" class="headerlink" title="跨域限制"></a>跨域限制</h2><ol><li>无法读取非同源网页的 Cookie、LocalStorage 和 IndexedDB</li><li>无法接触非同源网页的 DOM</li><li>无法向非同源地址发送 AJAX 请求（可以发送，但浏览器会拒绝接受响应）</li></ol><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>跨域资源分享CORS<br>后端添加Access-Control-Allow-Origin返回头，允许通过的域</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;跨域&quot;&gt;&lt;a href=&quot;#跨域&quot; class=&quot;headerlink&quot; title=&quot;跨域&quot;&gt;&lt;/a&gt;跨域&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;    浏览器自身存在保护机制，当从一个域名访问另一个域名的资源时，域名、端口、协议任一不同，都会产生跨域问题
&lt;/code</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
  </entry>
  
  <entry>
    <title>Vim</title>
    <link href="https://dogfun.top/2021/11/28/linux/vim/"/>
    <id>https://dogfun.top/2021/11/28/linux/vim/</id>
    <published>2021-11-28T03:15:15.000Z</published>
    <updated>2022-02-22T02:12:50.585Z</updated>
    
    <content type="html"><![CDATA[<h1 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h1><h2 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h2><h3 id="移动光标"><a href="#移动光标" class="headerlink" title="移动光标"></a>移动光标</h3><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>h</td><td>左移动</td></tr><tr><td>j</td><td>下移动</td></tr><tr><td>k</td><td>上移动</td></tr><tr><td>l</td><td>右移动</td></tr><tr><td>ctrl+d</td><td>下移动半页</td></tr><tr><td>ctrl+u</td><td>上移动半页</td></tr><tr><td>gg</td><td>移动到第一行</td></tr><tr><td>G</td><td>移动到最后一行</td></tr><tr><td>nG</td><td>移动到第n行</td></tr><tr><td>n+<space></td><td>右移n个字符</td></tr><tr><td>n+<enter></td><td>下移动n行</td></tr></tbody></table><h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>/word</td><td>向光标下搜索,n搜索下一个,shirt+n搜索上一个</td></tr><tr><td>?word</td><td>向光标上搜索</td></tr></tbody></table><h3 id="删除、复制与粘贴"><a href="#删除、复制与粘贴" class="headerlink" title="删除、复制与粘贴"></a>删除、复制与粘贴</h3><h4 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h4><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>x</td><td>向后删除一个字符</td></tr><tr><td>nx</td><td>向后删除n个字符</td></tr><tr><td>dd</td><td>删除游标那正行</td></tr><tr><td>ndd</td><td>删除光标下n行</td></tr><tr><td>dG</td><td>全部删除</td></tr><tr><td>shift+6</td><td>到行尾</td></tr><tr><td>shift+4</td><td>到行头</td></tr><tr><td>ggdG</td><td>从首行开始删除所有</td></tr></tbody></table><h4 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h4><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>yy</td><td>复制那一行</td></tr><tr><td>nyy</td><td>复制光标下n行</td></tr></tbody></table><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>p</td><td>将已复制的数据贴到光标下一行</td></tr><tr><td>P</td><td>将已复制的数据贴到光标上一行</td></tr></tbody></table><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>u</td><td>复原前一个动作（撤回）</td></tr><tr><td>ctrl+r</td><td>重做上一个动作</td></tr></tbody></table><h2 id="切换到输入模式"><a href="#切换到输入模式" class="headerlink" title="切换到输入模式"></a>切换到输入模式</h2><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>i</td><td>目前光标所在处输入</td></tr><tr><td>I</td><td>从光标所在行的非空格字符输入</td></tr><tr><td>a</td><td>从目前光标所在的下一个字符开始输入</td></tr><tr><td>A</td><td>从目前光标所在的最后一个字符开始输入</td></tr><tr><td>o</td><td>从目前光标所在的行的下一行开始输入</td></tr><tr><td>O</td><td>从目前光标所在的行的上一行开始输入</td></tr></tbody></table><h2 id="命令模式切换到底线命令模式"><a href="#命令模式切换到底线命令模式" class="headerlink" title="命令模式切换到底线命令模式"></a>命令模式切换到底线命令模式</h2><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>:w</td><td>编辑的数据写入硬盘</td></tr><tr><td>:w!</td><td>强制写入硬盘，无权限还是写不进</td></tr><tr><td>:q</td><td>离开vi</td></tr><tr><td>:q!</td><td>修改过不想保存，强制离开vi</td></tr><tr><td>:wq</td><td>保存后离开</td></tr><tr><td>:w [filename]</td><td>另存为</td></tr></tbody></table><h2 id="vim环境的变更"><a href="#vim环境的变更" class="headerlink" title="vim环境的变更"></a>vim环境的变更</h2><table><thead><tr><th>按键</th><th>操作</th></tr></thead><tbody><tr><td>:set nu</td><td>显示行号</td></tr><tr><td>:set nonu</td><td>取消显示行号</td></tr></tbody></table><h1 id="组合实用"><a href="#组合实用" class="headerlink" title="组合实用"></a>组合实用</h1><p>yy:复制当前行<br>p: 复制的内容粘贴<br>f+[?]:偏移到某个字符<br>ciw:删除当前所处的词，并进入插入模式</p><p>块删除<br>vjd</p><p>删除某个块里的内容并进入插入模式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ci&#123;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  example</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;example&quot;;</span><br><span class="line"></span><br><span class="line">(example);</span><br></pre></td></tr></table></figure><h1 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h1><p>多行注释：</p><p>进入命令行模式–&gt;</p><p>将光标移动到要注释的第一行位置–&gt;</p><p>按ctrl + v进入 visual block模式–&gt;</p><p>按字母j,或k（或者上下移动键）纵向选中需要注释的行–&gt;</p><p>按大写字母I，进入插入模式–&gt;</p><p>输入注释符号，例如##（需要添加几列就输入几个）–&gt;</p><p>按esc键就注释多行了。</p><p>取消多行注释（删除注释）：</p><p>进入命令行模式–&gt;</p><p>将光标移动到要取消注释的第一行第一列位置–&gt;</p><p>按ctrl + v进入 visual block模式–&gt;</p><p>按小写字母h或l横向选中列的个数，按小写字母j或k纵向选中行的个数（同样可以使用上下左右移动键）–&gt;</p><h2 id="按d键或者delete键就可多行取消注释。"><a href="#按d键或者delete键就可多行取消注释。" class="headerlink" title="按d键或者delete键就可多行取消注释。"></a>按d键或者delete键就可多行取消注释。</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;基础命令&quot;&gt;&lt;a href=&quot;#基础命令&quot; class=&quot;headerlink&quot; title=&quot;基础命令&quot;&gt;&lt;/a&gt;基础命令&lt;/h1&gt;&lt;h2 id=&quot;命令模式&quot;&gt;&lt;a href=&quot;#命令模式&quot; class=&quot;headerlink&quot; title=&quot;命令模式&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="linux" scheme="https://dogfun.top/categories/linux/"/>
    
    
  </entry>
  
  <entry>
    <title>Minio</title>
    <link href="https://dogfun.top/2021/11/27/%E4%B8%AD%E9%97%B4%E4%BB%B6/minio/"/>
    <id>https://dogfun.top/2021/11/27/%E4%B8%AD%E9%97%B4%E4%BB%B6/minio/</id>
    <published>2021-11-27T01:49:06.000Z</published>
    <updated>2021-11-28T03:34:17.993Z</updated>
    
    <content type="html"><![CDATA[<h2 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9000:9000 -p 9001:9001 -d --name minio1 \</span><br><span class="line">  -v /Users/carytseng/envir/minio/data:/data \</span><br><span class="line">  -v /Users/carytseng/envir/minio/config:/root/.minio \</span><br><span class="line">  -e &#x27;MINIO_ROOT_USER=admin&#x27; \</span><br><span class="line">  -e &#x27;MINIO_ROOT_PASSWORD=admin123&#x27; \</span><br><span class="line">  minio/minio server /data --console-address &quot;:9001&quot;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;docker安装&quot;&gt;&lt;a href=&quot;#docker安装&quot; class=&quot;headerlink&quot; title=&quot;docker安装&quot;&gt;&lt;/a&gt;docker安装&lt;/h2&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;t</summary>
      
    
    
    
    <category term="中间件" scheme="https://dogfun.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>随想11-27</title>
    <link href="https://dogfun.top/2021/11/27/%E9%9A%8F%E6%83%B3/%E9%9A%8F%E6%83%B311-27/"/>
    <id>https://dogfun.top/2021/11/27/%E9%9A%8F%E6%83%B3/%E9%9A%8F%E6%83%B311-27/</id>
    <published>2021-11-27T01:49:06.000Z</published>
    <updated>2021-11-28T03:34:18.005Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>   泛娱乐时代倘若不能保持独立思考的能力，建立自己的观念防线，极其容易被喂养垃圾价值观而不自知，在碎片化的无意识信息汲取中得不到任何有养分的熏陶，谈何成长，不变成shit就不错了。走向平庸只需几步，失去专注力、固步自封害怕触及新领域、沉浸在自我建立的舒适区中。只需要两三年，基本的格局即会定调，再想改变是难上加难，毕竟人的天性对于大多数人来讲是不可抗力因素。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;   泛娱乐时代倘若不能保持独立思考的能力，建立自己的观念防线，极其容易被喂养垃圾价值观而不自知，在碎片化的无意识信息汲取中得不到任何有养分的熏陶，谈何成长，不变成shit就不错了。走向平庸只需几步，失去专注力、固步自封害怕触及新领域、沉浸在自我建</summary>
      
    
    
    
    <category term="随想" scheme="https://dogfun.top/categories/%E9%9A%8F%E6%83%B3/"/>
    
    
  </entry>
  
  <entry>
    <title>NVM</title>
    <link href="https://dogfun.top/2021/10/25/web/NVM/"/>
    <id>https://dogfun.top/2021/10/25/web/NVM/</id>
    <published>2021-10-25T01:49:06.000Z</published>
    <updated>2021-12-14T13:04:21.036Z</updated>
    
    <content type="html"><![CDATA[<p>1、nvm安装。nvm是node版本管理工具，为解决node各版本不兼容问题，nvm是让你在同一台机器上安装和切换不同版本的node</p><ol><li><p>brew install nvm</p></li><li><p>编辑配置文件，vim ~/.bash_profile，文件中写入如下内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=~/.nvm</span><br><span class="line">source $(brew --prefix nvm)/nvm.sh</span><br></pre></td></tr></table></figure></li><li><p>保存，source ~/.bash_profile</p></li></ol><p>2、nvm切换镜像源，解决node下载卡/失败的问题</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br><span class="line">// 加入以下两条配置文件</span><br><span class="line">export NVM_NODEJS_ORG_MIRROR=http://npm.taobao.org/mirrors/node</span><br><span class="line">export NVM_IOJS_ORG_MIRROR=http://npm.taobao.org/mirrors/iojs</span><br><span class="line">// 重启配置文件</span><br><span class="line">source ~/.bashrc</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3、安装node指定版本</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nvm ls-remote  // 查看所有的node可用版本</span><br><span class="line">nvm list  // 查看已安装node版本</span><br><span class="line">nvm install 版本号  // 下载指定node版本，如nvm install v11.14.0</span><br><span class="line">nvm use 版本号  // 使用指定版本</span><br><span class="line">nvm alias default  // 设置默认版本，每次启动终端都使用该版本</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1、nvm安装。nvm是node版本管理工具，为解决node各版本不兼容问题，nvm是让你在同一台机器上安装和切换不同版本的node&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;brew install nvm&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;编辑配置文件，vim ~/.bash_p</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
  </entry>
  
  <entry>
    <title>Mac平台下工具总结</title>
    <link href="https://dogfun.top/2021/09/25/%E6%95%88%E7%8E%87/mac/"/>
    <id>https://dogfun.top/2021/09/25/%E6%95%88%E7%8E%87/mac/</id>
    <published>2021-09-25T01:49:06.000Z</published>
    <updated>2021-11-28T03:51:13.742Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收藏软件网站"><a href="#收藏软件网站" class="headerlink" title="收藏软件网站"></a>收藏软件网站</h2><p><a href="https://www.macwk.com/" title="macwk">macwk</a></p><h2 id="必备工具"><a href="#必备工具" class="headerlink" title="必备工具"></a>必备工具</h2><ul><li>解压：Bandizip</li><li>影音：IINA</li><li>终端替代：iTerm2</li><li>文档阅览：PDF Expert</li><li>浏览器下载：NeatDownloadManager</li><li>磁力链接必备：迅雷</li><li>系统清理：Disk diet</li><li>本地索引搜索：HapiGo</li><li>外网工具：Clash</li><li>文档编辑：wps</li><li>邮件收发（主要可设代理，方便gmail）：Formail</li><li>文件管理器替代：TotalFinder</li></ul><h2 id="工作必备"><a href="#工作必备" class="headerlink" title="工作必备"></a>工作必备</h2><ul><li>MarkDown编辑：Typora</li><li>文本编辑：Sublime Text</li><li>Java开发：IDEA</li><li>数据库图形化：Navicat</li><li>git图形化工具：SourceTree</li><li>svn工具：Cornerstone</li><li>接口调试：PostMan</li><li>UML工具：draw.io</li><li>容器：docker</li><li>性能监控：JProfiler</li><li>文本对比：Beyond Compare</li><li>redis图形化工具：RDM</li><li>前端编辑：Visual Studio Code</li><li>ssh工具：Royal Tsx</li></ul><h3 id="文本编辑统一"><a href="#文本编辑统一" class="headerlink" title="文本编辑统一"></a>文本编辑统一</h3><p>将所有文本编辑类统一用visual studio code解决</p><ul><li>添加pretty json插件</li><li>markdown all in one插件</li></ul><h2 id="系统性能设置提升"><a href="#系统性能设置提升" class="headerlink" title="系统性能设置提升"></a>系统性能设置提升</h2><h3 id="设置性能模式"><a href="#设置性能模式" class="headerlink" title="设置性能模式"></a>设置性能模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">开启性能模式</span><br><span class="line">sudo nvram boot-args=&quot;serverperfmode=1 $(nvram boot-args 2&gt;/dev/null | cut -f 2-)&quot;</span><br><span class="line"></span><br><span class="line">关闭性能模式</span><br><span class="line">sudo nvram boot-args=&quot;$(nvram boot-args 2&gt;/dev/null | sed -e $&#x27;s/boot-args\t//;s/serverperfmode=1//&#x27;)&quot;</span><br><span class="line"></span><br><span class="line">查看当前模式</span><br><span class="line">nvram boot-args</span><br></pre></td></tr></table></figure><h3 id="设置显卡模式"><a href="#设置显卡模式" class="headerlink" title="设置显卡模式"></a>设置显卡模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pmset -a GPUSwitch 0 // 强制使用集显</span><br><span class="line"></span><br><span class="line">sudo pmset -a GPUSwitch 1 // 强制使用独显</span><br><span class="line"></span><br><span class="line">sudo pmset -a GPUSwitch 2 // 自动切换模式</span><br></pre></td></tr></table></figure><h3 id="mac-上的-spotlight开关"><a href="#mac-上的-spotlight开关" class="headerlink" title="mac 上的 spotlight开关"></a>mac 上的 spotlight开关</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">关闭：</span><br><span class="line">sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist</span><br><span class="line">打开（注意要使用HapiGo必须要打开，依赖此引擎）：</span><br><span class="line">sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">常年使用mac平台总结出的优良体验，日常的效率工具，有助提升个人工作效率</summary>
    
    
    
    <category term="效率" scheme="https://dogfun.top/categories/%E6%95%88%E7%8E%87/"/>
    
    
  </entry>
  
  <entry>
    <title>Java基础补全</title>
    <link href="https://dogfun.top/2021/08/05/java/java/"/>
    <id>https://dogfun.top/2021/08/05/java/java/</id>
    <published>2021-08-05T11:59:19.000Z</published>
    <updated>2022-01-03T05:09:39.206Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><ul><li><p>boolean (8bit),byte(8bit),char(16bit),short(16bit),int(32bit),long(64bit),float(32bit),double(64bit),void</p></li><li><p>Boolean,Byte,Character,Integer,Long,Float,Double,Void</p></li></ul><h2 id="Java源文件名与类public修饰符"><a href="#Java源文件名与类public修饰符" class="headerlink" title="Java源文件名与类public修饰符"></a>Java源文件名与类public修饰符</h2><blockquote><p> 一个java源文件作为编译器的一个编译单元，可以有多个类，若有public类，则该类名与源文件名必须相同且只有一个，但源文件中不是必须含有public类，public类知识用来表示编译单元中存在公开接口。编译的时候java编译器判断如果存在public类，就将该类当做编译单元的对外接口，类加载器需要把该类加载。对于一个public类可以被项目中任何一个类引用。若源文件中含有public类，且含有main方法，则main方法必须在public类中定义。因为public类是对外的公开接口。</p></blockquote><h2 id="amp-和-amp-amp-的区别"><a href="#amp-和-amp-amp-的区别" class="headerlink" title="&amp;和&amp;&amp;的区别"></a>&amp;和&amp;&amp;的区别</h2><p>&amp;&amp;是短路操作符:若操作符左边的布尔表达式能推算出整个表达式的布尔值，则不计算右边的表达式。</p><p>&amp;是非短路操作符:始终会计算两边的布尔表达式。</p><h2 id="与equals"><a href="#与equals" class="headerlink" title="==与equals"></a>==与equals</h2><p>==比较两个变量的值是否相等，也就是变量所存储的数值是否相等</p><p>若是基本类型，比较数值大小</p><p>若是对象类型，比较引用变量所指向的对象是否是同一个。</p><p>equals用于比较两个独立的对象是否相同，equals方法可覆盖，定义相同的条件</p><h2 id="创建对象的几种方式"><a href="#创建对象的几种方式" class="headerlink" title="创建对象的几种方式"></a>创建对象的几种方式</h2><ol><li><p>用new语句创建对象，这是最常用的创建对象的方式。</p></li><li><p>运用反射手段，调用<a href="http://lib.csdn.net/base/javase">Java</a>.lang.Class或者java.lang.reflect.Constructor类的newInstance()实例方法。</p></li><li><p>调用对象的clone()方法。</p></li><li><p>运用反序列化手段，调用java.io.ObjectInputStream对象的readObject()方法.</p></li></ol><h2 id="equal和hashcode"><a href="#equal和hashcode" class="headerlink" title="equal和hashcode"></a>equal和hashcode</h2><p>​        哈希码位于对象头中，每个对象都有。主要用于查找，如HashSet在存放对象时会使用对象的哈希码来计算存储位置，HashSet是不能存放相同的两个对象的，这个相同由我们自己定义，也即是equals方法。</p><p>为什么要保证equals方法相同的两个对象 hashcode相同？</p><ol><li><p>假设equals定义了两个相同的对象，而未覆写hashcode，则hashset容器根据不同的hashcode将两个对象都放进去。重写了，就会判断同一位置上已有相同的对象。</p></li><li><p>假设有相同hashcode，则会算出相同的存储位置，若不覆写equals方法，默认调用object的equals方法，比较两个引用地址，不同就都放进去，在同一位置上使用链表存储。所以必须覆写equals方法保证对象的合法性。</p></li></ol><h2 id="值传递和引用传递"><a href="#值传递和引用传递" class="headerlink" title="值传递和引用传递"></a>值传递和引用传递</h2><blockquote><p>java基本数据类型是值传递，修改值不会对原来的值造成影响，对象类型都是引用传递，将对象引用的地址传递给方法参数，方法中修改对象属性即修改指向的内存空间上的对象的属性，java的方法只支持值传递。</p></blockquote><h2 id="方法重载与方法覆写"><a href="#方法重载与方法覆写" class="headerlink" title="方法重载与方法覆写"></a>方法重载与方法覆写</h2><p>方法重载发生在一个类中，多个同名函数同时存在，具有不同的参数个数、类型,调用方法时通过传递给它们的不同参数个数和参数类型决定具体使用哪个方法，这就是多态（编译时绑定），无法以返回类型作为重载标准。</p><p>方法覆写主要是子类对父类方法的重写，相同的名称和参数。子类函数的访问权限不能少于父类的。</p><p>动态绑定：</p><ol><li><p>编译器检查对象声明的类型和方法名，从而获取所有候选方法。</p></li><li><p>当程序运行并且使用动态绑定来调用一个方法时，那么虚拟机必须调用对象的实际类型相匹配的方法版本。</p></li></ol><ul><li><p>一个是编译时绑定，根据代码传入的参数类型或者个数来确定调用的方法</p></li><li><p>一个是运行时绑定，根据传入的对象类型，确定调用子类抑或父类的方法</p></li></ul><h2 id="静态变量与实例变量"><a href="#静态变量与实例变量" class="headerlink" title="静态变量与实例变量"></a>静态变量与实例变量</h2><p>语法定义：静态变量加static关键字，实例变量不需要</p><p>程序运行区别：</p><p>   实例变量与实例对象关联，必须创建实例对象，才能使用对象的实例变量。</p><p>   而静态变量与类关联，随着类的加载而被分配空间，无须创建对象，并且静态变量只分配了一次。</p><h2 id="static"><a href="#static" class="headerlink" title="static"></a>static</h2><blockquote><p>被static修饰的成员变量和成员方法独立于该类的任何对象。也就是说，它不依赖类特定的实例，被类的所有实例共享。只要这个类被加载，Java虚拟机就能根据类名在运行时数据区的方法区内定找到他们。因此，static对象可以在它的任何对象创建之前访问，无需引用任何对象。 </p></blockquote><ol><li><p>static变量</p><p>　按照是否静态的对类成员变量进行分类可分两种：一种是被static修饰的变量，叫静态变量或类变量；另一种是没有被static修饰的变量，叫实例变量。两者的区别是： </p><p>   　对于静态变量在内存中只有一个拷贝（节省内存），JVM只为静态分配一次内存，在加载类的过程中完成静态变量的内存分配，可用类名直接访问（方便），当然也可以通过对象来访问（但是这是不推荐的）。 </p><p>   　对于实例变量，没创建一个实例，就会为实例变量分配一次内存，实例变量可以在内存中有多个拷贝，互不影响（灵活）。 </p></li><li><p>静态方法</p><p>　静态方法可以直接通过类名调用，任何的实例也都可以调用，因此静态方法中不能用this和super关键字，不能直接访问所属类的实例变量和实例方法(就是不带static的成员变量和成员成员方法)，只能访问所属类的静态成员变量和成员方法。因为实例成员与特定的对象关联！这个需要去理解，想明白其中的道理，不是记忆！！！ </p><p>   　因为static方法独立于任何实例，因此static方法必须被实现，而不能是抽象的abstract。 </p></li><li><p>static代码块</p><p>　static代码块也叫静态代码块，是在类中独立于类成员的static语句块，可以有多个，位置可以随便放，它不在任何的方法体内，JVM加载类时会执行这些静态的代码块，如果static代码块有多个，JVM将按照它们在类中出现的先后顺序依次执行它们，每个代码块只会被执行一次。例如：</p></li></ol><h2 id="final"><a href="#final" class="headerlink" title="final"></a>final</h2><p>final用于声明类，方法和变量，表示属性不可变，类不可继承，方法不可覆写。</p><ul><li><p>final 数据：编译期常量，这类常量必须是基本数据类型，使用static、final修饰。 对于对象引用使用final时，使引用恒定不变，但对于对象本身是可以被改变的，即指向恒定不变。定义时需要赋值</p></li><li><p>final方法：继承类不能覆盖基类的方法</p></li><li><p>final类：不能被继承</p></li></ul><h2 id="String-、StringBuilder、StringBuffer"><a href="#String-、StringBuilder、StringBuffer" class="headerlink" title="String 、StringBuilder、StringBuffer"></a>String 、StringBuilder、StringBuffer</h2><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul><li><p>执行速度方面：StringBuilder&gt;StringBuffer&gt;String </p></li><li><p>String创建的是字符串常量，是不可变的，操作时会不断创建新的对象，原来的对象会被GC回收掉。而StringBuilder和StringBuffer是字符串变量，操作时是对同一个对象进行。</p></li><li><p>StringBuilder：线程非安全</p></li><li><p>StringBuffer：线程安全</p></li><li><p>String若用==比较，则比较的是对象的地址。String方法重写了equals方法，所以比较时，比较的是字符串的内容是否相同。</p></li></ul><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p>创建字符串的方式: </p><ol><li><p>使用new关键字创建字符串,比如String s1 = new String(“abc”); </p></li><li><p>直接指定.比如String s2 = “abc”; </p></li><li><p>使用串联生成新的字符串.比如String s3 = “ab” + “c”; </p></li></ol><blockquote><p>Java运行时会维护一个String Pool(String池),JavaDoc翻译很模糊”字符串缓冲区”.String池用来存放运行时中产生的各种字符串,并且池中的字符串的内容不重复.而一般对象不存在这个缓冲池,并且创建的对象仅仅存在于方法的堆栈区。</p></blockquote><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ul><li><p>原理1:当使用任何方式来创建一个字符串对象s时,Java运行时(运行中JVM)会拿着这个X在String池中找是否存在内容相同的字符串对象,如果不存在,则在池中创建一个字符串s,否则,不在池中添加. </p></li><li><p>原理2:Java中,只要使用new关键字来创建对象,则一定会(在堆区或栈区)创建一个新的对象. </p></li><li><p>原理3:使用直接指定或者使用纯字符串串联来创建String对象,则仅仅会检查维护String池中的字符串,池中没有就在池中创建一个,有则罢了!但绝不会在堆栈区再去创建该String对象. </p></li><li><p>原理4:使用包含变量的表达式来创建String对象,则不仅会检查维护String池,而且还会在堆栈区创建一个String对象. </p></li><li><p>javac编译可以对字符串常量直接相加的表达式进行优化，不必要等到运行期去进行加法运算处理，而是在编译时去掉取中的加号</p></li></ul><h3 id="常见问题："><a href="#常见问题：" class="headerlink" title="常见问题："></a>常见问题：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">String s1 = &quot;a&quot;;</span><br><span class="line"></span><br><span class="line">String s2 = s1 + &quot;b&quot;;//含有变量，因此会先检查维护String池，并在堆中创建一个新对象</span><br><span class="line"></span><br><span class="line">String s3 = &quot;a&quot; + &quot;b&quot;;</span><br><span class="line"></span><br><span class="line">System.out.println(s2 == &quot;ab&quot;);//false,&quot;ab&quot;的地址在常量池中，而s2指向的是堆中所copy的对象</span><br><span class="line"></span><br><span class="line">System.out.println(s3 == &quot;ab&quot;);//true</span><br><span class="line"></span><br><span class="line">System.out.println(s3 == s2);//false</span><br><span class="line"></span><br><span class="line">String s1 = &quot;a&quot;;</span><br><span class="line"></span><br><span class="line">String s2 = &quot;a&quot; + &quot;b&quot;;//直接在常量池中创建一个新的</span><br><span class="line"></span><br><span class="line">String s3 = &quot;a&quot; + &quot;b&quot;;//使用常量池中存在的</span><br><span class="line"></span><br><span class="line">System.out.println(s2 == &quot;ab&quot;);//true</span><br><span class="line"></span><br><span class="line">System.out.println(s3 == s2);//true</span><br></pre></td></tr></table></figure><h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><blockquote><p>线程本地变量，对于一个变量，ThreadLocal为该变量在每个线程中创建一个副本，线程间的变量互不影响。适用场景，多个线程不依赖于共享变量的状态来进行逻辑驱动，适用于在每个线程中，保存一份变量副本，对于该副本的任何修改也仅限于该线程的操作，其他线程无法影响。</p></blockquote><p><strong>设计理念</strong></p><blockquote><p>概括起来说，对于多线程资源共享的问题，同步机制采用了“以时间换空间”的方式，而ThreadLocal采用了“以空间换时间”的方式。前者仅提供一份变量，让不同的线程排队访问，而后者为每一个线程都提供了一份变量，做到多线程的数据隔离。</p></blockquote><p><strong>设计原理</strong></p><p>​        每个线程Thread类会维护一个变量ThreadLocalMap，该map是以ThreadLocal作为key，保存的变量值作为value保存在当前线程的ThreadLocalMap中，所以每个线程可以存储多个ThreadLocal的变量值。set的时候，拿到当前线程的ThreadLocalMap，若map为空则初始化，否则set进变量值。get的时候，是获取当前线程的ThreadLocalMap，以该ThreadLocal作为key来获取变量值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public void set(T value) &#123;</span><br><span class="line">  Thread t = Thread.currentThread();</span><br><span class="line">  ThreadLocalMap map = getMap(t);</span><br><span class="line">  if (map != null)</span><br><span class="line">    map.set(this, value);</span><br><span class="line">  else</span><br><span class="line">    createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public T get() &#123;</span><br><span class="line">  Thread t = Thread.currentThread();</span><br><span class="line">  ThreadLocalMap map = getMap(t);</span><br><span class="line">  if (map != null) &#123;</span><br><span class="line">    ThreadLocalMap.Entry e = map.getEntry(this);</span><br><span class="line">    if (e != null) </span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">      T result = (T)e.value;</span><br><span class="line">      return result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return setInitialValue();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="类加载及双亲委派模型"><a href="#类加载及双亲委派模型" class="headerlink" title="类加载及双亲委派模型"></a>类加载及双亲委派模型</h2><h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><h4 id="加载："><a href="#加载：" class="headerlink" title="加载："></a>加载：</h4><p>​        查找并加载二进制数据。把类的.class文件中的二进制数据读入内存，把它存放到方法区，然后在堆创建一个Class对象，用来封装类在方法区内的数据结构，提供了访问类在方法区内的数据结构的接口。</p><h4 id="连接："><a href="#连接：" class="headerlink" title="连接："></a>连接：</h4><ol><li><p>验证：确保被加载类的正确性。</p></li><li><p>准备：为类的静态变量分配内存，并将其初始化为默认值。</p></li><li><p>解析：把类中的符号引用转换为直接引用。</p></li><li><p>初始化：给类的静态变量赋予正确的初始值。</p><ol><li>假如这个类还没有被加载和连接，就先进行加载和连接。</li><li>假如这个类存在父类，并且这个父类还没有初始化，就先初始化。</li><li>假如这个类存在初始化语句，就依次执行。</li></ol></li></ol><h4 id="初始化的时机："><a href="#初始化的时机：" class="headerlink" title="初始化的时机："></a>初始化的时机：</h4><ul><li><p>创建类的实例：new、反射、克隆及序列化。</p></li><li><p>调用类的静态方法。</p></li><li><p>访问某个类或接口的静态变量。</p></li><li><p>调用java api的某些反射方法。</p></li><li><p>初始一个类的子类</p></li></ul><p>类及对象创建的初始化顺序</p><ol><li>父类–静态变量</li><li>父类–静态初始化块</li><li>子类–静态变量</li><li>子类–静态初始化块</li><li>父类–变量</li><li>父类–初始化块</li><li>父类–构造器</li><li>子类–变量</li><li>子类–初始化块</li><li>子类–构造器</li></ol><p>双亲委派模型：Bootstrap ClassLoader、Extension ClassLoader、ApplicationClassLoader。</p><blockquote><p>如果一个类加载器收到类加载的请求，首先不会自己尝试加载，先委派给父类加载器去完成，只有当父加载器无法加载时，子加载器才会尝试加载。这种机制下用户自定义的类加载器不可能加载由父加载器加载的可靠类，从而防止不可靠的恶意代码。</p></blockquote><h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><h3 id="Error与Exception"><a href="#Error与Exception" class="headerlink" title="Error与Exception"></a>Error与Exception</h3><ul><li><p>Error是程序无法处理的错误，比如OutOfMemoryError、ThreadDeath等。这些异常发生时， Java虚拟机（JVM）一般会选择线程终止。</p></li><li><p>Exception是程序本身可以处理的异常，这种异常分两大类运行时异常和非运行时异常。  程序中应当尽可能去处理这些异常。</p><ul><li><p>运行时异常：</p><blockquote><p>运行时异常都是RuntimeException类及其子类异常，如NullPointerException、IndexOutOfBoundsException、ArithmeticException、 IllegalArgumentException 等， 这些异常是不检查异常，程序中可以选择捕获处理，也可以不处理。这些异常一般是由程序逻辑错误引起的，程序应该从逻辑角度尽可能避免这类异常的发生。</p></blockquote></li><li><p>非运行时异常    </p><blockquote><p>非运行时异常是RuntimeException以外的异常，类型上都属于Exception类及其子类。从程序语法角度讲是必须进行处理的异常，如果不处理，程序就不能编译通过。如IOException、SQLException等以及用户自定义的Exception异常，一般情况下不自定义检查异常。</p></blockquote></li></ul></li></ul><h3 id="try语句块"><a href="#try语句块" class="headerlink" title="try语句块"></a>try语句块</h3><blockquote><p>表示要尝试运行代码，try语句块中代码受异常监控，其中代码发生异常时，会抛出异常对象。</p></blockquote><h3 id="catch语句块"><a href="#catch语句块" class="headerlink" title="catch语句块"></a>catch语句块</h3><blockquote><p>捕获try代码块中发生的异常并在其代码块中做异常处理，catch语句带一个Throwable类型的参数，表示可捕获异常类型。当try中出现异常时，catch会捕获到发生的异常，并和自己的异常类型匹配，  若匹配，则执行catch块中代码，并将catch块参数指向所抛的异常对象。catch语句可以有多个，用来匹配多个中的一个异常，一旦匹配上后，就不再尝试匹配别的catch块了。通过异常对象可以获取异常发生时完整的JVM堆栈信息，以及异常信息和异常发生的原因等。</p></blockquote><h3 id="finally语句块"><a href="#finally语句块" class="headerlink" title="finally语句块"></a>finally语句块</h3><blockquote><p>是紧跟catch语句后的语句块，这个语句块总是会在方法返回前执行，而不管是否try语句块是否发生异常。并且这个语句块总是在方法返回前执行。目的是给程序一个补救的机会。这样做也体现了Java语言的健壮性。</p></blockquote><h3 id="try、catch、finally三个语句块应注意的问题"><a href="#try、catch、finally三个语句块应注意的问题" class="headerlink" title="try、catch、finally三个语句块应注意的问题"></a>try、catch、finally三个语句块应注意的问题</h3><ol><li>try、catch、finally三个语句块均不能单独使用，三者可以组成 try…catch…finally、try…catch、</li></ol><p>  try…finally三种结构，catch语句可以有一个或多个，finally语句最多一个。</p><ol start="2"><li>try、catch、finally三个代码块中变量的作用域为代码块内部，分别独立而不能相互访问。</li></ol><p>  如果要在三个块中都可以访问，则需要将变量定义到这些块的外面。</p><ol start="3"><li>多个catch块时候，只会匹配其中一个异常类并执行catch块代码，而不会再执行别的catch块，</li></ol><p>  并且匹配catch语句的顺序是由上到下。</p><h3 id="throw、throws关键字"><a href="#throw、throws关键字" class="headerlink" title="throw、throws关键字"></a>throw、throws关键字</h3><blockquote><p>throw关键字是用于方法体内部，用来抛出一个Throwable类型的异常。如果抛出了检查异常，则还应该在方法头部声明方法可能抛出的异常类型。该方法的调用者也必须检查处理抛出的异常。如果所有方法都层层上抛获取的异常，最终JVM会进行处理，处理也很简单，就是打印异常消息和堆栈信息。如果抛出的是Error或RuntimeException，则该方法的调用者可选择处理该异常。有关异常的转译会在下面说明。</p><p>throws关键字用于方法体外部的方法声明部分，用来声明方法可能会抛出某些异常。仅当抛出了检查异常，该方法的调用者才必须处理或者重新抛出该异常。当方法的调用者无力处理该异常的时候，应该继续抛出，而不是囫囵吞枣一般在catch块中打印一下堆栈信息做个勉强处理。</p></blockquote><h3 id="try中return，则finally语句是否执行，什么时候执行？"><a href="#try中return，则finally语句是否执行，什么时候执行？" class="headerlink" title="try中return，则finally语句是否执行，什么时候执行？"></a>try中return，则finally语句是否执行，什么时候执行？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class smallT &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        smallT t = new smallT();</span><br><span class="line">        int b = t.get();</span><br><span class="line">        System.out.println(b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int get() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return 1;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            return 2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先返回1，最终返回的是2。</p><p>try中的return 语句调用的函数先于 finally中调用的函数执行，也就是说 return语句先执行，finally语句后执行，所以，返回的结果是 2。Return 并不是让函数马上返回，而是 return语句执行后，将把返回结果放置进函数栈中，此时函数并不是马上返回，它要执行 finally语句后才真正开始返回。</p><h1 id="高级应用"><a href="#高级应用" class="headerlink" title="高级应用"></a>高级应用</h1><h2 id="流式处理"><a href="#流式处理" class="headerlink" title="流式处理"></a>流式处理</h2><blockquote><p>将待处理的集合当成流经过管道的处理，比如筛选、排序、聚合等，得到最终想要的结果。</p></blockquote><p>forEach</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Random random = new Random(); </span><br><span class="line"></span><br><span class="line">random.ints().limit(10).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">//打印对象</span><br><span class="line"></span><br><span class="line">students.stream().forEach(s-&gt;&#123;</span><br><span class="line"></span><br><span class="line">   System.out.println(s.getName())</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>map</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(3, 2, 2, 3, 7, 3, 5);</span><br><span class="line"></span><br><span class="line"> // 获取对应的平方数 </span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; squaresList = numbers.stream().map( i -&gt; i*i).distinct().collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>filter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt;strings = Arrays.asList(&quot;abc&quot;, &quot;&quot;, &quot;bc&quot;, &quot;efg&quot;, &quot;abcd&quot;,&quot;&quot;, &quot;jkl&quot;); </span><br><span class="line"></span><br><span class="line">// 获取空字符串的数量 </span><br><span class="line"></span><br><span class="line">long count = strings.stream().filter(string -&gt; string.isEmpty()).count();</span><br></pre></td></tr></table></figure><p>limit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Random random = new Random(); </span><br><span class="line"></span><br><span class="line">random.ints().limit(10).sorted().forEach(System.out::println);</span><br></pre></td></tr></table></figure><p>order</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//按照对象的某个属性排序</span><br><span class="line"></span><br><span class="line">students.stream().sorted(Comparator.comparing(Student::getBirthday)).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">//倒序</span><br><span class="line"></span><br><span class="line">students.stream().sorted(Comparator.comparing(Student::getBirthday).reversed()).collect(Collectors.toList());</span><br></pre></td></tr></table></figure><p>match</p><ul><li>allMatch：Stream 中全部元素符合则返回 true ;</li><li>anyMatch：Stream 中只要有一个元素符合则返回 true;</li><li>noneMatch：Stream 中没有一个元素符合则返回 true。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">boolean all = lists.stream().allMatch(u -&gt; u.getId() &gt; 3);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;是否都大于3:&quot; + all);</span><br><span class="line"></span><br><span class="line">boolean any = lists.stream().anyMatch(u -&gt; u.getId() &gt; 3);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;是否有一个大于3:&quot; + any);</span><br><span class="line"></span><br><span class="line">boolean none = lists.stream().noneMatch(u -&gt; u.getId() &gt; 3);</span><br><span class="line"></span><br><span class="line">System.out.println(&quot;是否没有一个大于3的:&quot; + none);    </span><br><span class="line"></span><br><span class="line">// 是否都大于3:false</span><br><span class="line"></span><br><span class="line">// 是否有一个大于3:true</span><br><span class="line"></span><br><span class="line">// 是否没有一个大于3的:false</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基本数据类型&quot;&gt;&lt;a href=&quot;#基本数据类型&quot; class=&quot;headerlink&quot; title=&quot;基本数据类型&quot;&gt;&lt;/a&gt;基本数据类型&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;boolean (8bit),byte(8bit),char(16bit),short(1</summary>
      
    
    
    
    <category term="java" scheme="https://dogfun.top/categories/java/"/>
    
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://dogfun.top/2020/11/29/%E6%95%88%E7%8E%87/%E6%95%88%E7%8E%87/"/>
    <id>https://dogfun.top/2020/11/29/%E6%95%88%E7%8E%87/%E6%95%88%E7%8E%87/</id>
    <published>2020-11-29T13:00:15.569Z</published>
    <updated>2021-12-04T12:21:10.502Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h2><h3 id="快速代码生成"><a href="#快速代码生成" class="headerlink" title="快速代码生成"></a>快速代码生成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psvm  生成main方法</span><br><span class="line">sout  生成System.out.println</span><br></pre></td></tr></table></figure><h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cmd+o 定位类查找</span><br><span class="line"></span><br><span class="line">cmd+shift+f 查找文件</span><br><span class="line"></span><br><span class="line">shift+shift 所有文件查找</span><br><span class="line"></span><br><span class="line">option+f7. 定位使用到的地方</span><br><span class="line"></span><br><span class="line">cmd+b 声明或使用到的地方</span><br><span class="line"></span><br><span class="line">option+cmd+b 定位接口实现类</span><br><span class="line"></span><br><span class="line">cmd+u 定位实现的接口或者继承类</span><br><span class="line"></span><br><span class="line">cmd+b 定位调用方</span><br><span class="line"></span><br><span class="line">cmd+\ 插件定位controller方法</span><br><span class="line"></span><br><span class="line">alt+cmd+b 定位实现类</span><br></pre></td></tr></table></figure><h4 id="类生成"><a href="#类生成" class="headerlink" title="类生成"></a>类生成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctrl+enter 类生成方法</span><br><span class="line"></span><br><span class="line">cmd+n 生成构造、test、equal、overwrite等</span><br></pre></td></tr></table></figure><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmd+shift+u 大小写切换</span><br><span class="line"></span><br><span class="line">cmd+l 定位文件行&amp;列</span><br><span class="line"></span><br><span class="line">cmd+b 回到调用位置</span><br><span class="line"></span><br><span class="line">cmd+[+]/[-]展开代码/折叠代码</span><br><span class="line"></span><br><span class="line">cmd+shift+[+]/[-]展开所有代码/折叠所有代码</span><br></pre></td></tr></table></figure><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h4 id="系统监测"><a href="#系统监测" class="headerlink" title="系统监测"></a>系统监测</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps -ef 显示运行进程</span><br><span class="line"></span><br><span class="line">top 实时显示系统进程及参数</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -n</span><br><span class="line"> -e </span><br><span class="line"> </span><br><span class="line">type</span><br></pre></td></tr></table></figure><h2 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h2><table><thead><tr><th>根据路径打开文件</th><th>shirt+cmd+g</th></tr></thead><tbody><tr><td>打开访达</td><td>cmd+n</td></tr><tr><td>搜词</td><td>option+/</td></tr><tr><td>全局搜索</td><td>option+space</td></tr><tr><td>我的电脑</td><td>cmd+shirt+h</td></tr><tr><td>新建文件夹</td><td>cmd+shirt+n</td></tr><tr><td>同一个应用多开切换</td><td>cmd+`</td></tr><tr><td>桌面</td><td>f11</td></tr></tbody></table><h2 id="Markdown"><a href="#Markdown" class="headerlink" title="Markdown"></a>Markdown</h2><table><thead><tr><th>添加目录</th><th>[toc]</th></tr></thead><tbody><tr><td>h1</td><td>#</td></tr><tr><td>块引用</td><td>&gt;</td></tr><tr><td>列表</td><td>* || 1.</td></tr><tr><td>代码块</td><td>```</td></tr><tr><td>加粗</td><td><strong>?</strong></td></tr><tr><td>图片引入</td><td><img src="path"></td></tr><tr><td>下划线</td><td>***</td></tr><tr><td>表格</td><td>||||</td></tr></tbody></table><h2 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h2><table><thead><tr><th>新建文章</th><th>hexo n “hello world”</th></tr></thead><tbody><tr><td>新建页面</td><td>hexo new page “pageName”</td></tr><tr><td>生成静态页面至public目录</td><td>hexo g</td></tr><tr><td>开启预览访问端口</td><td>hexo s</td></tr><tr><td>上传部署</td><td>hexo d</td></tr><tr><td>帮助</td><td>hexo help</td></tr><tr><td>生成并本地预览</td><td>hexo s -g</td></tr><tr><td>生成并上传</td><td>hexo d -g</td></tr></tbody></table><h2 id="Alfred"><a href="#Alfred" class="headerlink" title="Alfred"></a>Alfred</h2><h4 id="文件目录搜索"><a href="#文件目录搜索" class="headerlink" title="文件目录搜索"></a>文件目录搜索</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find [file]</span><br><span class="line">open [file]</span><br></pre></td></tr></table></figure><h4 id="文本内容搜索"><a href="#文本内容搜索" class="headerlink" title="文本内容搜索"></a>文本内容搜索</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in [file]</span><br></pre></td></tr></table></figure><h4 id="快捷网页搜索"><a href="#快捷网页搜索" class="headerlink" title="快捷网页搜索"></a>快捷网页搜索</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">google something</span><br><span class="line">wiki something</span><br><span class="line">bing something</span><br></pre></td></tr></table></figure><h4 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yd []</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;IDEA&quot;&gt;&lt;a href=&quot;#IDEA&quot; class=&quot;headerlink&quot; title=&quot;IDEA&quot;&gt;&lt;/a&gt;IDEA&lt;/h2&gt;&lt;h3 id=&quot;快速代码生成&quot;&gt;&lt;a href=&quot;#快速代码生成&quot; class=&quot;headerlink&quot; title=&quot;快速代码生</summary>
      
    
    
    
    <category term="效率" scheme="https://dogfun.top/categories/%E6%95%88%E7%8E%87/"/>
    
    
  </entry>
  
  <entry>
    <title>ignite迁移</title>
    <link href="https://dogfun.top/2020/11/28/vps/ignite%E8%BF%81%E7%A7%BB/"/>
    <id>https://dogfun.top/2020/11/28/vps/ignite%E8%BF%81%E7%A7%BB/</id>
    <published>2020-11-28T11:59:19.000Z</published>
    <updated>2021-11-28T03:51:13.741Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">新主机docker脚本安装</span></span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure><ul><li><p>docker-compose.yml&amp;ignite.db文件cp</p></li><li><p>容器服务导出导入</p><ul><li>生成容器快照，打出镜像<ul><li>docker commit -p [containerId] [alias]</li></ul></li><li>生成tar文件<ul><li>docker save -o ~/[filename].tar [imageName]</li></ul></li><li>导入tar文件<ul><li>cat [tarfile] |docker import - [name]</li></ul></li></ul></li><li><p>原主机获取容器启动命令相关参数</p><ul><li><p>安装runlike</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-pip</span><br><span class="line">pip install runlike</span><br><span class="line"><span class="meta">#</span><span class="bash">查看启动参数</span></span><br><span class="line">runlike -p [containerid]</span><br><span class="line">cp</span><br></pre></td></tr></table></figure></li></ul></li><li><p>启动ssr子容器所有服务，获得所有containerid，修改ignite.db中表user的service_id</p></li><li><p>docker-compose run –rm ignite-admin /bin/sh -c ‘./ignite-admin recover’</p></li><li><p>docker-compose up -d</p></li></ul>]]></content>
    
    
    <summary type="html">ignite服务主机迁移，主要是docker容器的备份迁移</summary>
    
    
    
    <category term="vps" scheme="https://dogfun.top/categories/vps/"/>
    
    
  </entry>
  
  <entry>
    <title>CAP定理</title>
    <link href="https://dogfun.top/2020/11/04/web/CAP%E5%AE%9A%E7%90%86/"/>
    <id>https://dogfun.top/2020/11/04/web/CAP%E5%AE%9A%E7%90%86/</id>
    <published>2020-11-04T13:41:57.000Z</published>
    <updated>2021-11-28T03:51:13.741Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>面试被问到CAP定理，之前看过，真正问起来讲得不清楚，估计没有真正的理解这个定理，故作此文进行记录</p></blockquote><p>分布式系统有三个指标，也即一致性、可用性、分区容错</p><p>（C）一致性：多个节点的数据保持一致，当某个节点的数据修改后，需要同步修改所有节点的数据，保持一致</p><p>（A）可用性：即当某个节点宕机后，整个集群还能正常对外服务，保证服务健康</p><p>（P）分区容错：两个节点间可能会无法通信，P定理总是成立的。</p><p>一致性和可用性不可能同时成立，因为P即分区容错总是可能出现，如果要保证一致性，则必须保证所有节点都收到该数据的同步，才能对外服务，这就不满足可用性。如果满足可用性，即某个节点崩坏了也要提供服务，那么就不能保证一致性。</p><p>所以一般需要根据业务需要，保证C或A其中一个特性，例如网页更新可以采取可用性，因为最终用户都会看到最新的版本；如果是银行等金融数据，需要保证强一致性，则需要抛弃可用性。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;面试被问到CAP定理，之前看过，真正问起来讲得不清楚，估计没有真正的理解这个定理，故作此文进行记录&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;分布式系统有三个指标，也即一致性、可用性、分区容错&lt;/p&gt;
&lt;p&gt;（C）一致性：多个节点的数据保持一致，当</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
  </entry>
  
  <entry>
    <title>redis</title>
    <link href="https://dogfun.top/2020/10/28/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/"/>
    <id>https://dogfun.top/2020/10/28/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/</id>
    <published>2020-10-28T07:13:07.000Z</published>
    <updated>2021-12-06T09:01:41.610Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>工作中接触Redis大多仅用来作为缓存，也用过来做分布式锁，对于内部的实现机制及高级用法几乎是走马观花，故作此文用来记录相关的知识点，从原理出发慢慢拓展此文，全部用自己的理解话术来进行记录，个人理解，有误请指出。</p></blockquote><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>Redis诞生之初是为了解决关系型数据库的性能问题，由于IO需要对磁盘的读写速度满足不了实际场景，因此创造者利用内存造了一个内存数据库，没有关系型数据库的约束，Redis提供的数据结构简单且能满足高性能的读写场景，其基于对内存的读写，能够在短时间内处理数据，由于读写速度快，免去IO的局限，IO涉及操作系统用户空间与内核空间的数据复制及事件等待，所以redis采用单线程的处理模型，免去线程切换的开销，因为也没必要进行多线程处理</p><h3 id="对比memcached"><a href="#对比memcached" class="headerlink" title="对比memcached"></a>对比memcached</h3><p>支持多种数据结构，memcached仅支持字符串且不支持持久化</p><h2 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h2><p>Redis采用基于Reactor模式开发网络事件处理器，采用IO多路复用技术，简单来说就是一条线程监听多个客户端socket，当有事件到时，将事件作为一个task放到队列中，接下来文件处理器会对队列中的task进行处理，文件处理器是单线程的，没有线程的切换问题，文件处理器包含连接应答器、命令请求处理器、命令回复处理器，执行相应的命令后，返回相应。这也是Redis速度快的原因：IO多路复用、单线程处理task、基于内存的数据操作</p><p><img src="/assets/blog_img/timg.jpeg" alt="timg"></p><h2 id="Redis数据结构"><a href="#Redis数据结构" class="headerlink" title="Redis数据结构"></a>Redis数据结构</h2><p>基于键值的存储，值支持以下几种类型</p><ul><li>string：字符串<ul><li>字节串：非字符自增会报错</li><li>整数：可自增减</li><li>浮点数</li></ul></li><li>list：有序队列<ul><li>可用作队列</li></ul></li><li>set：集合</li><li>hash：散列</li><li>zset：有序集合<ul><li>相比散列，提供基于分值的相关功能，每个key有对应的score，应对一些场景应用</li></ul></li></ul><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>Redis提供持久化的功能，能够将内存的数据定时写入硬盘，保证数据在系统重启后能够恢复，继续进行服务</p><p>两种持久化的方式：</p><ul><li>快照</li><li>AOF</li></ul><h3 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h3><p>　　快照：会开启一个子进程定时对内存的数据进行打快照，使用BGSAVE命令，缺点是快照是按周期打，性能有限，一旦系统崩溃，会丢失从上次快照之后的数据，也有可能在刚打完快照就崩溃。而且打快照可能会造成Redis停顿</p><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>　　AOF：将Redis的执行命令记录下来，记录到AOF文件中，可根据需要设置频率，恢复时只需要执行相应的写命令即可。缺点是AOF的文件会随着内存数据的增大而增大，造成磁盘爆满，可以使用命令对AOF文件重写，压缩冗余的部分</p><p>同步频率</p><ul><li><p>always：每个命令都写入磁盘</p></li><li><p>everysec：每秒同步一次，多个命令到磁盘</p></li><li><p>no：由系统决定写入时间</p></li></ul><h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><p>水平添加多个Redis实例，通过主从服务器来满足高性能的读写请求。主服务器将快照文件发送到从服务器，从服务器获得快照并初始化数据</p><h3 id="过期时间设置"><a href="#过期时间设置" class="headerlink" title="过期时间设置"></a>过期时间设置</h3><p>Redis提供过期时间设置保证内存空间，也能保证热数据</p><p>Redis后台有两种方式对过期数据进行删除</p><ul><li>定期删除：每隔一段时间抽取过期的key然后删除</li><li>惰性删除：当系统查询到这个过期key时会删除</li></ul><h3 id="热key问题"><a href="#热key问题" class="headerlink" title="热key问题"></a>热key问题</h3><p>针对某个key的大流量请求，造成物理机的网卡超载，导致Redis宕机引发雪崩</p><p>解决思路：</p><ul><li>提前把key打到不同的服务器</li><li>加入二级缓存，提前加载热key到内存</li></ul><h3 id="缓存击穿-缓存穿透-缓存雪崩"><a href="#缓存击穿-缓存穿透-缓存雪崩" class="headerlink" title="缓存击穿|缓存穿透|缓存雪崩"></a>缓存击穿|缓存穿透|缓存雪崩</h3><h4 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h4><p>类似热key问题，区别点在于key的过期导致请求打在DB上</p><p>解决思路：</p><ul><li>加锁更新，对key进行加锁，在数据库查询前就进行了拦截</li><li>过期时间写在value中，用异步方式刷新过期时间</li></ul><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><p>查询缓存中不存在的key，恶意请求大量制造不存在的key直接请求DB</p><p>解决思路：</p><ul><li>加一层布隆过滤器</li></ul><h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><p>某一时刻可能发生大规模的缓存失效，例如缓存服务宕机，大量的key同时失效，请求打到DB，导致整个系统雪崩</p><ul><li>不同的key设置不同的过期时间，避免同时过期</li><li>限流，降低db压力</li><li>二级缓存</li></ul><h2 id="redis分布式锁实现秒杀业务"><a href="#redis分布式锁实现秒杀业务" class="headerlink" title="redis分布式锁实现秒杀业务"></a>redis分布式锁实现秒杀业务</h2><p>　　曾经做过一个类似秒杀系统的模块，系统采用分布式架构，场景是这样子的，用户提了故障单后，有跟踪故障单的需求，衍生了催单，用户会通过多个客户端去提交催单，用户催单有专人去跟踪，有一定的时效性，需要及时处理反馈。</p><span id="more"></span><p>业务规则</p><ul><li>同一个工单号一个用户15分钟内只能提一次催单</li><li>同一个工单号不同用户15分钟内只产生一条催单，新增的用户则追加子记录</li></ul><p><strong>问题</strong></p><ol><li>需要考虑并发操作</li><li>保证分布式环境下业务的正确处理</li><li>考虑大流量请求下服务处理压力</li></ol><p>　　虽然系统是运营商的内部系统，tob的用户量并不会很大，但站在技术角度，需要考虑如果toc要怎么满足的问题。首先处理并发问题，因为多个用户对于同一个工单的业务操作是竞争的，因此需要对同一个工单号上锁，其次要满足高可用，因此在多服务运行环境下，需要引入分布式锁，查了下分布式锁的解决方案可以使用redis或者数据库锁（通过数据库插入记录的唯一性保证），这里使用redis分布式锁来解决，且针对用户的重复查询，使用redis缓存来降低DB的压力，这样15分钟内用户的多次查询都能命中缓存，以此解决问题3。</p><p><strong>分布式锁的方案及原理</strong></p><ul><li><p>数据库加锁</p><p>数据库锁主要是利用行记录的唯一性来保护资源，插入失败即继续重试，直至获取到锁。需要自己考虑锁超时，事务等。</p></li><li><p>Redis锁</p><p>利用sexNx方法的原子特性实现，多个进程竞争set值，只有一个进程set成功则为获取锁成功，需要设置锁的过期时间防止宕机，redis2.8以前需要使用lua脚本来保证setNx与过期时间设置保证原子操作，2.8以后能支持nx和ex是同一操作。可以使用redission客户端，封装了锁的实现。</p></li><li><p>zookeeper锁</p><p>使用Curator框架，其封装了zookeeper的API，提供分布式锁的实现。原理是zookeeper有一个临时有序节点的概念，在某个目录加锁会生成一个节点，后来的客户端会有序生成排列，然后先到的客户端会检测自己是不是第一个节点，是的话就加锁成功，否则寻找当前节点的上一个节点，并且添加监听器。当上一个节点操作完毕释放锁会删除自己的节点，此时监听到删除的下一个节点会尝试获取。这里不用保证超时，因为zookeeper能够检测客户端的健康状态，当失活后能够删除当前节点，这也就是zookeeper锁的原理</p></li></ul><p><img src="/assets/blog_img/%E7%94%A8%E6%88%B7%E5%B9%B6%E5%8F%91%E5%82%AC%E5%8D%95%E6%B5%81%E7%A8%8B.png" alt="流程图"></p><p><strong>伪代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">submitCallOrder</span><span class="params">(String orderNum, String userName)</span></span>&#123;</span><br><span class="line">  String cacheUserOrderNum;</span><br><span class="line">  <span class="comment">//缓存取是否催单，key以用户+工单号</span></span><br><span class="line">  cacheUserOrderNum=template.opsForValue().get(userName+<span class="string">&quot;:&quot;</span>+orderNum);</span><br><span class="line">  <span class="keyword">if</span>(Strings.isNotBlank(cacheUserOrderNum))&#123;</span><br><span class="line"><span class="comment">//用户已催单</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//加锁，获取不到一直阻塞</span></span><br><span class="line">  <span class="keyword">while</span>(!redisLockHelper.lock(orderNum,String.valueOf(time)))&#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询是否有15分钟内的催单</span></span><br><span class="line">  Order dbOrder=orderMapper.existLatestCallOrder(orderNum);</span><br><span class="line">  <span class="keyword">if</span>(dbOrder==<span class="keyword">null</span>)&#123;</span><br><span class="line">    <span class="comment">//没有则新增催单</span></span><br><span class="line">    orderMapper.insert(order);</span><br><span class="line">    <span class="comment">//新增催单用户子记录</span></span><br><span class="line">    subOrderMapper.insert(subOrder);</span><br><span class="line">    <span class="comment">//缓存数据</span></span><br><span class="line">    template.opsForValue().set(userName+<span class="string">&quot;:&quot;</span>+orderNum,<span class="string">&quot;1&quot;</span>, TimeUnit.MINUTES.toMinutes(<span class="number">15</span>));</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//用户15分钟内是否催过单</span></span><br><span class="line">    <span class="keyword">if</span>(subOrderMapper.existLatestSubCallOrder(orderNum,userName))&#123;</span><br><span class="line">      <span class="comment">//缓存数据</span></span><br><span class="line">      template.opsForValue().set(userName+<span class="string">&quot;:&quot;</span>+orderNum,<span class="string">&quot;1&quot;</span>, TimeUnit.MINUTES.toMinutes(<span class="number">15</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//新增催单用户子记录</span></span><br><span class="line">      subOrderMapper.insert(subOrder);</span><br><span class="line">   <span class="comment">//更新催单主记录最近催单时间</span></span><br><span class="line">      orderMapper.updateByPrimaryKeySelective(order);</span><br><span class="line">      <span class="comment">//缓存数据</span></span><br><span class="line">      template.opsForValue().set(userName+<span class="string">&quot;:&quot;</span>+orderNum,<span class="string">&quot;1&quot;</span>, TimeUnit.MINUTES.toMinutes(<span class="number">15</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//释放锁</span></span><br><span class="line">  redisLockHelper.unlock(orderNum,String.valueOf(time));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Redis分布式锁工具类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLockHelper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetId   targetId - 唯一标志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeStamp  当前时间+超时时间 也就是时间戳</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lock</span><span class="params">(String targetId,String timeStamp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(stringRedisTemplate.opsForValue().setIfAbsent(targetId,timeStamp))&#123;</span><br><span class="line">            <span class="comment">// 对应setnx命令，可以成功设置,也就是key不存在</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断锁超时 - 防止原来的操作异常，没有运行解锁操作  防止死锁</span></span><br><span class="line">        String currentLock = stringRedisTemplate.opsForValue().get(targetId);</span><br><span class="line">        <span class="comment">// 如果锁过期 currentLock不为空且小于当前时间</span></span><br><span class="line">        <span class="keyword">if</span>(!Strings.isNullOrEmpty(currentLock) &amp;&amp; Long.parseLong(currentLock) &lt; System.currentTimeMillis())&#123;</span><br><span class="line">            <span class="comment">// 获取上一个锁的时间value 对应getset，如果lock存在</span></span><br><span class="line">            String preLock =stringRedisTemplate.opsForValue().getAndSet(targetId,timeStamp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 假设两个线程同时进来这里，因为key被占用了，而且锁过期了。获取的值currentLock=A(get取的旧的值肯定是一样的),两个线程的timeStamp都是B,key都是K.锁时间已经过期了。</span></span><br><span class="line">            <span class="comment">// 而这里面的getAndSet一次只会一个执行，也就是一个执行之后，上一个的timeStamp已经变成了B。只有一个线程获取的上一个值会是A，另一个线程拿到的值是B。</span></span><br><span class="line">            <span class="keyword">if</span>(!Strings.isNullOrEmpty(preLock) &amp;&amp; preLock.equals(currentLock) )&#123;</span><br><span class="line">                <span class="comment">// preLock不为空且preLock等于currentLock，也就是校验是不是上个对应的商品时间戳，也是防止并发</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeStamp</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(String target,String timeStamp)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String currentValue = stringRedisTemplate.opsForValue().get(target);</span><br><span class="line">            <span class="keyword">if</span>(!Strings.isNullOrEmpty(currentValue) &amp;&amp; currentValue.equals(timeStamp) )&#123;</span><br><span class="line">                <span class="comment">// 删除锁状态</span></span><br><span class="line">                stringRedisTemplate.opsForValue().getOperations().delete(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;警报！警报！警报！解锁异常&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/mokitkira/order/tree/master">github源码地址</a></p><h2 id="redis批量删除"><a href="#redis批量删除" class="headerlink" title="redis批量删除"></a>redis批量删除</h2><blockquote><p>redis没有提供针对key的模糊删除支持，提供的keys命令会一次性扫描库中符合条件的记录，没有分页设置，可能由于数据量过大造成redis卡顿，影响正常业务进行，在生产中应该摒弃用keys命令来扫描。</p></blockquote><h3 id="Scan命令"><a href="#Scan命令" class="headerlink" title="Scan命令"></a>Scan命令</h3><p>该命令是redis2.8提供的，相比keys命令，它是通过游标分步进行，不会对线程造成阻塞，提供匹配功能。游标的意思，redis的数据结构是基于hash的，类似java的hashmap，底层也是数组+链表，这里通过游标遍历。</p><p>SCAN CURSOR [MATCH pattern] [COUNT count]</p><p>CURSOR代表游标，每次扫描都会返回上次的游标以此来开始增量的扫描，count指扫描槽位的数量，可以理解为扫描hashmap中一维数组中多少个元素并返回这些槽组的数据，判断是否有符合的元素。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanAndDel</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           redisTemplate.execute((RedisCallback&lt;Boolean&gt;) redisConnection -&gt;</span><br><span class="line">           &#123;</span><br><span class="line">               Object nativeConnection = redisConnection.getNativeConnection();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// lettuce 单机</span></span><br><span class="line">               <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> RedisAsyncCommands) &#123;</span><br><span class="line">                   RedisAsyncCommands connection = (RedisAsyncCommands) nativeConnection;</span><br><span class="line"></span><br><span class="line">                   RedisCommands&lt;<span class="keyword">byte</span>[], String&gt; commands = connection.getStatefulConnection().sync();</span><br><span class="line"></span><br><span class="line">                   KeyScanCursor&lt;<span class="keyword">byte</span>[]&gt; scanCursor = <span class="keyword">null</span>;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (scanCursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           scanCursor = commands.scan(ScanArgs.Builder.matches(key));</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           scanCursor = commands.scan(scanCursor, ScanArgs.Builder.matches(key));</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       List&lt;<span class="keyword">byte</span>[]&gt; byteKeys = scanCursor.getKeys();</span><br><span class="line">                       <span class="keyword">if</span> (byteKeys.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="keyword">byte</span>[][] keys = <span class="keyword">new</span> <span class="keyword">byte</span>[byteKeys.size()][];</span><br><span class="line">                           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; byteKeys.size(); i++) &#123;</span><br><span class="line">                               keys[i] = byteKeys.get(i);</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           commands.del(keys);</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">while</span> (!scanCursor.isFinished());</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// lettuce 集群</span></span><br><span class="line">               <span class="keyword">if</span> (nativeConnection <span class="keyword">instanceof</span> RedisAdvancedClusterAsyncCommands) &#123;</span><br><span class="line">                   RedisAdvancedClusterAsyncCommands connection = (RedisAdvancedClusterAsyncCommands) nativeConnection;</span><br><span class="line"></span><br><span class="line">                   RedisAdvancedClusterCommands&lt;<span class="keyword">byte</span>[], String&gt; commands = connection.getStatefulConnection().sync();</span><br><span class="line"></span><br><span class="line">                   KeyScanCursor&lt;<span class="keyword">byte</span>[]&gt; scanCursor = <span class="keyword">null</span>;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (scanCursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                           scanCursor = commands.scan(ScanArgs.Builder.matches(key));</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           scanCursor = commands.scan(scanCursor, ScanArgs.Builder.matches(key));</span><br><span class="line">                       &#125;</span><br><span class="line"></span><br><span class="line">                       List&lt;<span class="keyword">byte</span>[]&gt; byteKeys = scanCursor.getKeys();</span><br><span class="line">                       <span class="keyword">if</span> (byteKeys.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="keyword">byte</span>[][] keys = <span class="keyword">new</span> <span class="keyword">byte</span>[byteKeys.size()][];</span><br><span class="line">                           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; byteKeys.size(); i++) &#123;</span><br><span class="line">                               keys[i] = byteKeys.get(i);</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           commands.del(keys);</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">while</span> (!scanCursor.isFinished());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;工作中接触Redis大多仅用来作为缓存，也用过来做分布式锁，对于内部的实现机制及高级用法几乎是走马观花，故作此文用来记录相关的知识点，从原理出发慢慢拓展此文，全部用自己的理解话术来进行记录，个人理解，有误请指出。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;Redis&quot;&gt;&lt;a href=&quot;#Redis&quot; class=&quot;headerlink&quot; title=&quot;Redis&quot;&gt;&lt;/a&gt;Redis&lt;/h2&gt;&lt;p&gt;Redis诞生之初是为了解决关系型数据库的性能问题，由于IO需要对磁盘的读写速度满足不了实际场景，因此创造者利用内存造了一个内存数据库，没有关系型数据库的约束，Redis提供的数据结构简单且能满足高性能的读写场景，其基于对内存的读写，能够在短时间内处理数据，由于读写速度快，免去IO的局限，IO涉及操作系统用户空间与内核空间的数据复制及事件等待，所以redis采用单线程的处理模型，免去线程切换的开销，因为也没必要进行多线程处理&lt;/p&gt;
&lt;h3 id=&quot;对比memcached&quot;&gt;&lt;a href=&quot;#对比memcached&quot; class=&quot;headerlink&quot; title=&quot;对比memcached&quot;&gt;&lt;/a&gt;对比memcached&lt;/h3&gt;&lt;p&gt;支持多种数据结构，memcached仅支持字符串且不支持持久化&lt;/p&gt;
&lt;h2 id=&quot;请求处理&quot;&gt;&lt;a href=&quot;#请求处理&quot; class=&quot;headerlink&quot; title=&quot;请求处理&quot;&gt;&lt;/a&gt;请求处理&lt;/h2&gt;&lt;p&gt;Redis采用基于Reactor模式开发网络事件处理器，采用IO多路复用技术，简单来说就是一条线程监听多个客户端socket，当有事件到时，将事件作为一个task放到队列中，接下来文件处理器会对队列中的task进行处理，文件处理器是单线程的，没有线程的切换问题，文件处理器包含连接应答器、命令请求处理器、命令回复处理器，执行相应的命令后，返回相应。这也是Redis速度快的原因：IO多路复用、单线程处理task、基于内存的数据操作&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/assets/blog_img/timg.jpeg&quot; alt=&quot;timg&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;Redis数据结构&quot;&gt;&lt;a href=&quot;#Redis数据结构&quot; class=&quot;headerlink&quot; title=&quot;Redis数据结构&quot;&gt;&lt;/a&gt;Redis数据结构&lt;/h2&gt;&lt;p&gt;基于键值的存储，值支持以下几种类型&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;string：字符串&lt;ul&gt;
&lt;li&gt;字节串：非字符自增会报错&lt;/li&gt;
&lt;li&gt;整数：可自增减&lt;/li&gt;
&lt;li&gt;浮点数&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;list：有序队列&lt;ul&gt;
&lt;li&gt;可用作队列&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;set：集合&lt;/li&gt;
&lt;li&gt;hash：散列&lt;/li&gt;
&lt;li&gt;zset：有序集合&lt;ul&gt;
&lt;li&gt;相比散列，提供基于分值的相关功能，每个key有对应的score，应对一些场景应用&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;持久化&quot;&gt;&lt;a href=&quot;#持久化&quot; class=&quot;headerlink&quot; title=&quot;持久化&quot;&gt;&lt;/a&gt;持久化&lt;/h2&gt;&lt;p&gt;Redis提供持久化的功能，能够将内存的数据定时写入硬盘，保证数据在系统重启后能够恢复，继续进行服务&lt;/p&gt;
&lt;p&gt;两种持久化的方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;快照&lt;/li&gt;
&lt;li&gt;AOF&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;快照&quot;&gt;&lt;a href=&quot;#快照&quot; class=&quot;headerlink&quot; title=&quot;快照&quot;&gt;&lt;/a&gt;快照&lt;/h3&gt;&lt;p&gt;　　快照：会开启一个子进程定时对内存的数据进行打快照，使用BGSAVE命令，缺点是快照是按周期打，性能有限，一旦系统崩溃，会丢失从上次快照之后的数据，也有可能在刚打完快照就崩溃。而且打快照可能会造成Redis停顿&lt;/p&gt;
&lt;h3 id=&quot;AOF&quot;&gt;&lt;a href=&quot;#AOF&quot; class=&quot;headerlink&quot; title=&quot;AOF&quot;&gt;&lt;/a&gt;AOF&lt;/h3&gt;&lt;p&gt;　　AOF：将Redis的执行命令记录下来，记录到AOF文件中，可根据需要设置频率，恢复时只需要执行相应的写命令即可。缺点是AOF的文件会随着内存数据的增大而增大，造成磁盘爆满，可以使用命令对AOF文件重写，压缩冗余的部分&lt;/p&gt;
&lt;p&gt;同步频率&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;always：每个命令都写入磁盘&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;everysec：每秒同步一次，多个命令到磁盘&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;no：由系统决定写入时间&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;复制&quot;&gt;&lt;a href=&quot;#复制&quot; class=&quot;headerlink&quot; title=&quot;复制&quot;&gt;&lt;/a&gt;复制&lt;/h3&gt;&lt;p&gt;水平添加多个Redis实例，通过主从服务器来满足高性能的读写请求。主服务器将快照文件发送到从服务器，从服务器获得快照并初始化数据&lt;/p&gt;
&lt;h3 id=&quot;过期时间设置&quot;&gt;&lt;a href=&quot;#过期时间设置&quot; class=&quot;headerlink&quot; title=&quot;过期时间设置&quot;&gt;&lt;/a&gt;过期时间设置&lt;/h3&gt;&lt;p&gt;Redis提供过期时间设置保证内存空间，也能保证热数据&lt;/p&gt;
&lt;p&gt;Redis后台有两种方式对过期数据进行删除&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;定期删除：每隔一段时间抽取过期的key然后删除&lt;/li&gt;
&lt;li&gt;惰性删除：当系统查询到这个过期key时会删除&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;热key问题&quot;&gt;&lt;a href=&quot;#热key问题&quot; class=&quot;headerlink&quot; title=&quot;热key问题&quot;&gt;&lt;/a&gt;热key问题&lt;/h3&gt;&lt;p&gt;针对某个key的大流量请求，造成物理机的网卡超载，导致Redis宕机引发雪崩&lt;/p&gt;
&lt;p&gt;解决思路：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;提前把key打到不同的服务器&lt;/li&gt;
&lt;li&gt;加入二级缓存，提前加载热key到内存&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;缓存击穿-缓存穿透-缓存雪崩&quot;&gt;&lt;a href=&quot;#缓存击穿-缓存穿透-缓存雪崩&quot; class=&quot;headerlink&quot; title=&quot;缓存击穿|缓存穿透|缓存雪崩&quot;&gt;&lt;/a&gt;缓存击穿|缓存穿透|缓存雪崩&lt;/h3&gt;&lt;h4 id=&quot;缓存击穿&quot;&gt;&lt;a href=&quot;#缓存击穿&quot; class=&quot;headerlink&quot; title=&quot;缓存击穿&quot;&gt;&lt;/a&gt;缓存击穿&lt;/h4&gt;&lt;p&gt;类似热key问题，区别点在于key的过期导致请求打在DB上&lt;/p&gt;
&lt;p&gt;解决思路：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;加锁更新，对key进行加锁，在数据库查询前就进行了拦截&lt;/li&gt;
&lt;li&gt;过期时间写在value中，用异步方式刷新过期时间&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;缓存穿透&quot;&gt;&lt;a href=&quot;#缓存穿透&quot; class=&quot;headerlink&quot; title=&quot;缓存穿透&quot;&gt;&lt;/a&gt;缓存穿透&lt;/h4&gt;&lt;p&gt;查询缓存中不存在的key，恶意请求大量制造不存在的key直接请求DB&lt;/p&gt;
&lt;p&gt;解决思路：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;加一层布隆过滤器&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;缓存雪崩&quot;&gt;&lt;a href=&quot;#缓存雪崩&quot; class=&quot;headerlink&quot; title=&quot;缓存雪崩&quot;&gt;&lt;/a&gt;缓存雪崩&lt;/h4&gt;&lt;p&gt;某一时刻可能发生大规模的缓存失效，例如缓存服务宕机，大量的key同时失效，请求打到DB，导致整个系统雪崩&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不同的key设置不同的过期时间，避免同时过期&lt;/li&gt;
&lt;li&gt;限流，降低db压力&lt;/li&gt;
&lt;li&gt;二级缓存&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;redis分布式锁实现秒杀业务&quot;&gt;&lt;a href=&quot;#redis分布式锁实现秒杀业务&quot; class=&quot;headerlink&quot; title=&quot;redis分布式锁实现秒杀业务&quot;&gt;&lt;/a&gt;redis分布式锁实现秒杀业务&lt;/h2&gt;&lt;p&gt;　　曾经做过一个类似秒杀系统的模块，系统采用分布式架构，场景是这样子的，用户提了故障单后，有跟踪故障单的需求，衍生了催单，用户会通过多个客户端去提交催单，用户催单有专人去跟踪，有一定的时效性，需要及时处理反馈。&lt;/p&gt;</summary>
    
    
    
    <category term="中间件" scheme="https://dogfun.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>Spring多数据源加载</title>
    <link href="https://dogfun.top/2020/10/07/web/Spring%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A0%E8%BD%BD/"/>
    <id>https://dogfun.top/2020/10/07/web/Spring%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8A%A0%E8%BD%BD/</id>
    <published>2020-10-07T02:21:14.000Z</published>
    <updated>2021-11-28T03:51:13.741Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote><p>Spring引入多数据源的方式，系统扩展的过程中可能会引入多个数据源，查阅了一些博客，发现引入方式或多或少都需要引入新的配置类，这里记录下在不需要修改任何代码的情况下，扩展数据源的方式，以后只需要在配置文件添加配置就能直接引入。</p></blockquote><h3 id="引入方式"><a href="#引入方式" class="headerlink" title="引入方式"></a>引入方式</h3><ul><li>分包方式</li><li>参数化方式</li><li>注解+AOP</li></ul><h4 id="分包方式"><a href="#分包方式" class="headerlink" title="分包方式"></a>分包方式</h4><p>比较简单，哪个数据源的操作就走哪个mapper目录下的文件，一般就是两个库无任何关联的场景。</p><h4 id="参数化方式"><a href="#参数化方式" class="headerlink" title="参数化方式"></a>参数化方式</h4><p>根据传入的参数选择数据源，进行数据查询，个人比较推崇这一种方式。</p><h4 id="注解-AOP"><a href="#注解-AOP" class="headerlink" title="注解+AOP"></a>注解+AOP</h4><p>在特定的方式上添加自定义的注解，配置上需要选择的数据源值，AOP执行的时候通过获取注解上的值来切换，这种方式需要在方法上写死需要的数据源，不太灵活。</p><h3 id="引入数据源的思路"><a href="#引入数据源的思路" class="headerlink" title="引入数据源的思路"></a>引入数据源的思路</h3><ul><li>配置文件添加多个数据源</li><li>自定义数据源配置</li><li>注入Spring容器</li><li>利用ThreadLocal的上下文，实现线程与数据源的绑定关系</li><li>使用上用参数化还是AOP等都可以</li></ul><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">master:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">12345678</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/master?useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">slave1:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">12345678</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/slave1?useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">slave2:</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">12345678</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/slave2?useUnicode=true&amp;characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure><p>建立一个property类来映射配置，这样我们就能拿到多个数据源的配置了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceProperty</span> </span>&#123;</span><br><span class="line">  <span class="comment">//只映射datasource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; datasource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来我们就是将所有的配置转换成bean并且注入到Spring中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.demo.sv.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceProperty dynamicDataSourceProperty;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 功能描述: &lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 〈动态数据源bean 自动配置注册所有数据源〉</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dynamicDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//拿到Spring容器</span></span><br><span class="line">        DefaultListableBeanFactory listableBeanFactory = (DefaultListableBeanFactory) beanFactory;        </span><br><span class="line">        <span class="comment">/*获取yml所有数据源配置*/</span></span><br><span class="line">        Map&lt;String, Object&gt; datasource = dynamicDataSourceProperty.getDatasource();</span><br><span class="line">        Map&lt;Object, Object&gt; dataSourceMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        Optional.ofNullable(datasource).ifPresent(map -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) &#123;</span><br><span class="line">                <span class="comment">//创建数据源对象</span></span><br><span class="line">                HikariDataSource dataSource = (HikariDataSource) DataSourceBuilder.create().build();</span><br><span class="line">                String dataSourceId = entry.getKey();</span><br><span class="line">                configeDataSource(entry, dataSource);</span><br><span class="line">                <span class="comment">/*bean工厂注册每个数据源bean*/</span></span><br><span class="line">                listableBeanFactory.registerSingleton(dataSourceId, dataSource);</span><br><span class="line">                dataSourceMap.put(dataSourceId, dataSource);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//AbstractRoutingDataSource设置主从数据源</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DynamicDataSource(beanFactory.getBean(<span class="string">&quot;master&quot;</span>, DataSource.class), dataSourceMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从配置转换成bean</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configeDataSource</span><span class="params">(Map.Entry&lt;String, Object&gt; entry, HikariDataSource dataSource)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; dataSourceConfig = (Map&lt;String, Object&gt;) entry.getValue();</span><br><span class="line">        dataSource.setJdbcUrl(MapUtils.getString(dataSourceConfig, <span class="string">&quot;jdbcUrl&quot;</span>));</span><br><span class="line">        dataSource.setDriverClassName(MapUtils.getString(dataSourceConfig, <span class="string">&quot;driverClassName&quot;</span>));</span><br><span class="line">        dataSource.setUsername(MapUtils.getString(dataSourceConfig, <span class="string">&quot;username&quot;</span>));</span><br><span class="line">        dataSource.setPassword(MapUtils.getString(dataSourceConfig, <span class="string">&quot;password&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>切换数据源我们需要用到Spring提供的一个抽象类AbstractRoutingDataSource，这个类有个抽象方法determineTargetDataSource，我们通过继承这个类，并且实现determineTargetDataSource方法，这个determineTargetDataSource就是决定调用数据源的逻辑，简单来说这个方法算出key值，然后去数据源池取出我们需要的数据源。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicDataSource</span><span class="params">(DataSource defaultDataSource, Map&lt;Object, Object&gt; targetDataSource)</span> </span>&#123;</span><br><span class="line">        backupTargetDataSources = targetDataSource;</span><br><span class="line">        <span class="keyword">super</span>.setDefaultTargetDataSource(defaultDataSource);</span><br><span class="line">        <span class="keyword">super</span>.setTargetDataSources(backupTargetDataSources);</span><br><span class="line">        <span class="keyword">super</span>.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前的数据源：&#123;&#125;&quot;</span>,DynamicDataSourceContextHolder.getContextKey());</span><br><span class="line">      <span class="comment">//我们自己定义了一个DynamicDataSourceContextHolder来维护key，只要我们在方法调用前设置key，Spring会根据这个方法来决定数据源</span></span><br><span class="line">        <span class="keyword">return</span> DynamicDataSourceContextHolder.getContextKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类，Springboot项目要加入排除自动配置数据源注解@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SvApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">      <span class="comment">//根据需要切换我们需要的数据源</span></span><br><span class="line">        DynamicDataSourceContextHolder.setContextKey(<span class="string">&quot;slave2&quot;</span>);</span><br><span class="line">        List&lt;User&gt; users= userMapper.query();</span><br><span class="line">        DynamicDataSourceContextHolder.remove();</span><br><span class="line">        System.out.println(users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="关于多数据源的事务处理"><a href="#关于多数据源的事务处理" class="headerlink" title="关于多数据源的事务处理"></a>关于多数据源的事务处理</h3><p>当引入多数据源后，如果要加入事务处理，同一个事务中处理处理两个数据源的数据会失败，主要是因为第一个数据源打开数据库连接后，会加入ThreadLocal中与线程进行绑定，而此时第二个数据源再获取sqlSession，发现不为空，取的是第一个数据源的连接，所以会有问题。如果要支持，思路就是保证sqlSession的独立，但不能保证分布式事务的正确处理。查阅相关资料，可以使用XA协议，具体此文没有详细探讨。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;Spring引入多数据源的方式，系统扩展的过程中可能会引入多个数据源，查阅了一些博客，发现引入方式或多或少都需要引</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
    <category term="技术学习" scheme="https://dogfun.top/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="数据源" scheme="https://dogfun.top/tags/%E6%95%B0%E6%8D%AE%E6%BA%90/"/>
    
  </entry>
  
  <entry>
    <title>从零开始写框架-SpringMVC</title>
    <link href="https://dogfun.top/2020/09/30/web/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E6%A1%86%E6%9E%B6-SpringMVC/"/>
    <id>https://dogfun.top/2020/09/30/web/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E6%A1%86%E6%9E%B6-SpringMVC/</id>
    <published>2020-09-30T11:24:06.000Z</published>
    <updated>2021-11-28T03:51:13.747Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>前言：</p><p>　　最近打算提升下源码能力，跟着相关教程实现Spring框架，巩固下前面的学习知识，像反射、设计模式等，顺带熟悉一些API。像设计模式这类知识，只能通过代码实践来提升对其核心思想的理解，毕竟设计模式不是凭空产生的，而是在代码实践的过程中，通过不断地重构提炼，发现其奥妙之处，才产生相关的程序思想。</p></blockquote><h3 id="1-0-MVC"><a href="#1-0-MVC" class="headerlink" title="1.0 MVC"></a>1.0 MVC</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><h4 id="配置文件application-properties"><a href="#配置文件application-properties" class="headerlink" title="配置文件application.properties"></a>配置文件application.properties</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanPackage=com.gupaoedu.demo</span><br></pre></td></tr></table></figure><h4 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h4><p>这部分主要模拟Spring中我们常用的Autowired，Controller，RequestMapping，RequestParam，Service等。</p><p>注解文件：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GPAutowired &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GPController &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE,ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GPRequestMapping &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GPRequestParam &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GPService &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>web.xml文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>gpmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.gupaoedu.mvcframework.v1.servlet.GPDispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>application.properties<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>gpmvc<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Controller类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GPController</span></span><br><span class="line"><span class="meta">@GPRequestMapping(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GPAutowired</span></span><br><span class="line">    <span class="keyword">private</span> IDemoService demoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GPRequestMapping(&quot;/query&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(HttpServletRequest req, HttpServletResponse resp, <span class="meta">@GPRequestParam(&quot;name&quot;)</span> String name)</span></span>&#123;</span><br><span class="line">        String result = demoService.get(name);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            resp.getWriter().write(result);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GPRequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(HttpServletRequest req,HttpServletResponse resp,<span class="meta">@GPRequestParam(&quot;a&quot;)</span>Integer a,<span class="meta">@GPRequestParam(&quot;b&quot;)</span> Integer b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            resp.getWriter().write(a+<span class="string">&quot;+&quot;</span>+b+<span class="string">&quot;=&quot;</span>+(a+b));</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GPRequestMapping(&quot;/remove&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(HttpServletRequest req,HttpServletResponse resp,<span class="meta">@GPRequestParam(&quot;a&quot;)</span>Integer a,<span class="meta">@GPRequestParam(&quot;b&quot;)</span> Integer b)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDemoService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Service实现类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GPService</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoService</span> <span class="keyword">implements</span> <span class="title">IDemoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;my name is &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="核心思路："><a href="#核心思路：" class="headerlink" title="核心思路："></a>核心思路：</h4><p>思路：首先我们要实现SpringMVC，思考下需要什么组件，第一肯定是IOC容器，暂时可以使用Map来代替。还有就是能通过url来找controller的这么一个路由器，我们也可以用一个Map来存。上面的注解是标记文件的，我们需要扫描这部分标记有注解的文件，我们需要利用反射初始化相关类的实例，放到Map中，并且我们还要实现属性注入功能。</p><p>初始化中我们需要做以下工作：</p><ul><li>扫描配置文件</li><li>通过项目路径将注解相关的类，通过反射实例化</li><li>实现类中的属性注入功能</li><li>实现url与handler的映射，也即路由。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GPDispatcherServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; mapping = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doDispatch(req, resp);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;500 error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="comment">//获取请求url</span></span><br><span class="line">        String url = req.getRequestURI();</span><br><span class="line">        String contextPath = req.getContextPath();</span><br><span class="line">        url = url.replace(contextPath, <span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;/+&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.mapping.containsKey(url)) &#123;</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;404....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Method method = (Method) <span class="keyword">this</span>.mapping.get(url);</span><br><span class="line">        Map&lt;String, String[]&gt; params = req.getParameterMap();</span><br><span class="line">        method.invoke(<span class="keyword">this</span>.mapping.get(method.getDeclaringClass().getName()), <span class="keyword">new</span> Object[]&#123;req, resp, params.get(<span class="string">&quot;name&quot;</span>)[<span class="number">0</span>]&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//简易版本实现全部在一个方法中</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Properties configContext = <span class="keyword">new</span> Properties();</span><br><span class="line">            is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(config.getInitParameter(<span class="string">&quot;contextConfigLocation&quot;</span>)); </span><br><span class="line">          <span class="comment">//读取配置文件</span></span><br><span class="line">            configContext.load(is);</span><br><span class="line">            String scanPackage = configContext.getProperty(<span class="string">&quot;scanPackage&quot;</span>);</span><br><span class="line">            <span class="comment">//扫描配置路径下的类</span></span><br><span class="line">            doScanner(scanPackage);</span><br><span class="line">          <span class="comment">//实例化标有注解的类</span></span><br><span class="line">            <span class="keyword">for</span> (String className : mapping.keySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!className.contains(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">                <span class="keyword">if</span> (clazz.isAnnotationPresent(GPController.class)) &#123;</span><br><span class="line">                    mapping.put(className, clazz.newInstance());</span><br><span class="line">                    String baseUrl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">if</span> (clazz.isAnnotationPresent(GPRequestMapping.class)) &#123;</span><br><span class="line">                        GPRequestMapping requestMapping = clazz.getAnnotation(GPRequestMapping.class);</span><br><span class="line">                        baseUrl = requestMapping.value();</span><br><span class="line">                    &#125;</span><br><span class="line">                    Method[] methods = clazz.getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!method.isAnnotationPresent(GPRequestMapping.class)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        GPRequestMapping requestMapping = method.getAnnotation(GPRequestMapping.class);</span><br><span class="line">                        String url = (baseUrl + <span class="string">&quot;/&quot;</span> + requestMapping.value()).replaceAll(<span class="string">&quot;/+&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">                        mapping.put(url, method);</span><br><span class="line">                        System.out.println(<span class="string">&quot;Mapped &quot;</span> + url + <span class="string">&quot;,&quot;</span> + method);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isAnnotationPresent(GPService.class)) &#123;</span><br><span class="line">                    GPService service = clazz.getAnnotation(GPService.class);</span><br><span class="line">                    String beanName = service.value();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">                        beanName = clazz.getName();</span><br><span class="line">                    &#125;</span><br><span class="line">                    Object instance = clazz.newInstance();</span><br><span class="line">                    mapping.put(beanName, instance);</span><br><span class="line">                    <span class="keyword">for</span> (Class&lt;?&gt; i : clazz.getInterfaces()) &#123;</span><br><span class="line">                        mapping.put(i.getName(), instance);</span><br><span class="line">                        System.out.println(i.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//进行类的属性注入</span></span><br><span class="line">            <span class="keyword">for</span> (Object object : mapping.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (object == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Class clazz = object.getClass();</span><br><span class="line">                <span class="keyword">if</span> (clazz.isAnnotationPresent(GPController.class)) &#123;</span><br><span class="line">                    Field[] fileds = clazz.getDeclaredFields();</span><br><span class="line">                    <span class="keyword">for</span> (Field field : fileds) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!field.isAnnotationPresent(GPAutowired.class)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        GPAutowired autowired = field.getAnnotation(GPAutowired.class);</span><br><span class="line">                        String beanName = autowired.value();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">                            beanName = field.getType().getName();</span><br><span class="line">                        &#125;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        <span class="comment">//对象的属性设置为value</span></span><br><span class="line">                        field.set(mapping.get(clazz.getName()), mapping.get(beanName));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;GP mvc init...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//扫描所有的类</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doScanner</span><span class="params">(String scanPackage)</span> </span>&#123;</span><br><span class="line">        URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(<span class="string">&quot;/&quot;</span> + scanPackage.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">        File classDir = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">        <span class="keyword">for</span> (File file : classDir.listFiles()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">                doScanner(scanPackage + <span class="string">&quot;.&quot;</span> + file.getName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!file.getName().endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String clazzName = (scanPackage + <span class="string">&quot;.&quot;</span> + file.getName().replace(<span class="string">&quot;.class&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">                mapping.put(clazzName, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-0-MVC"><a href="#2-0-MVC" class="headerlink" title="2.0 MVC"></a>2.0 MVC</h3><p>1.0版本将所有的代码逻辑都写在init方法内，我们需要将相关的步骤抽取出来，进行优化</p><h4 id="init方法"><a href="#init方法" class="headerlink" title="init方法"></a>init方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line"><span class="comment">//加载配置文件</span></span><br><span class="line">    doLoadConfig(config.getInitParameter(<span class="string">&quot;contextConfigLocation&quot;</span>));</span><br><span class="line"><span class="comment">//扫描类</span></span><br><span class="line">    doScanner(contextConfig.getProperty(<span class="string">&quot;scanPackage&quot;</span>));</span><br><span class="line"><span class="comment">//反射实例化类</span></span><br><span class="line">    doInstance();</span><br><span class="line"><span class="comment">//注入</span></span><br><span class="line">    doAutowired();</span><br><span class="line"><span class="comment">//初始化url与方法映射关系</span></span><br><span class="line">    initHandlerMapping();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;GP mvc init...&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doLoadConfig方法"><a href="#doLoadConfig方法" class="headerlink" title="doLoadConfig方法"></a>doLoadConfig方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLoadConfig</span><span class="params">(String contextConfigLocation)</span> </span>&#123;</span><br><span class="line">    InputStream is = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        is = <span class="keyword">this</span>.getClass().getClassLoader().getResourceAsStream(contextConfigLocation);</span><br><span class="line">        contextConfig.load(is);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != is) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                is.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doScanner方法"><a href="#doScanner方法" class="headerlink" title="doScanner方法"></a>doScanner方法</h4><p>递归扫描所有类，将扫描到的类到放到List中，后面需要进行实例化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doScanner</span><span class="params">(String scanPackage)</span> </span>&#123;</span><br><span class="line">    URL url = <span class="keyword">this</span>.getClass().getClassLoader().getResource(<span class="string">&quot;/&quot;</span> + scanPackage.replaceAll(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>));</span><br><span class="line">    File classDir = <span class="keyword">new</span> File(url.getFile());</span><br><span class="line">    <span class="keyword">for</span> (File file : classDir.listFiles()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isDirectory()) &#123;</span><br><span class="line">            doScanner(scanPackage + <span class="string">&quot;.&quot;</span> + file.getName());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!file.getName().endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String clazzName = (scanPackage + <span class="string">&quot;.&quot;</span> + file.getName().replace(<span class="string">&quot;.class&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">            classNames.add(clazzName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doInstance方法"><a href="#doInstance方法" class="headerlink" title="doInstance方法"></a>doInstance方法</h4><p>实例化Bean，模拟将实例化的Bean放进IOC中，我们用一个Map来代替。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (classNames.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (String className : classNames) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz.isAnnotationPresent(GPController.class)) &#123;</span><br><span class="line">                Object instance = clazz.newInstance();</span><br><span class="line">                String beanName = toLowerFirstCase(clazz.getSimpleName());</span><br><span class="line">                ioc.put(beanName, instance);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isAnnotationPresent(GPService.class)) &#123;</span><br><span class="line">                GPService service = clazz.getAnnotation(GPService.class);</span><br><span class="line">                String beanName = service.value();</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">                    beanName = toLowerFirstCase(clazz.getSimpleName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Object instance = clazz.newInstance();</span><br><span class="line">                ioc.put(beanName, instance);</span><br><span class="line">                <span class="keyword">for</span> (Class&lt;?&gt; i : clazz.getInterfaces()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ioc.containsKey(i.getName())) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;the &quot;</span> + i.getName() + <span class="string">&quot; is exists&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    ioc.put(i.getName(), instance);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doAutowired方法进行注入"><a href="#doAutowired方法进行注入" class="headerlink" title="doAutowired方法进行注入"></a>doAutowired方法进行注入</h4><p>这一步我们将容器内的类取出来，通过反射将属性给拿到，通过扫描注解，再从容器中拿到相关的Bean然后注入到当前类的属性中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAutowired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioc.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : ioc.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//取出所有的属性</span></span><br><span class="line">        Field[] fields = entry.getValue().getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!field.isAnnotationPresent(GPAutowired.class)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            GPAutowired autowired = field.getAnnotation(GPAutowired.class);</span><br><span class="line">            String beanName = autowired.value().trim();</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(beanName)) &#123;</span><br><span class="line">                beanName = field.getType().getName();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field.set(entry.getValue(), ioc.get(beanName));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="initHandlerMapping方法"><a href="#initHandlerMapping方法" class="headerlink" title="initHandlerMapping方法"></a>initHandlerMapping方法</h4><p>这一步我们将所有Controller的方法拿到，并且拿到对应的url相对路径，并且将url与处理方法映射给保存起来，在请求路由的时候就根据url来找到相应的方法，通过反射执行对应方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHandlerMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioc.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : ioc.entrySet()) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = entry.getValue().getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!clazz.isAnnotationPresent(GPController.class)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String baseUrl = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (clazz.isAnnotationPresent(GPRequestMapping.class)) &#123;</span><br><span class="line">            GPRequestMapping gpRequestMapping = clazz.getAnnotation(GPRequestMapping.class);</span><br><span class="line">            baseUrl = gpRequestMapping.value();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Method method : clazz.getMethods()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!method.isAnnotationPresent(GPRequestMapping.class)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            GPRequestMapping gpRequestMapping = method.getAnnotation(GPRequestMapping.class);</span><br><span class="line"></span><br><span class="line">            String url = (<span class="string">&quot;/&quot;</span> + baseUrl + <span class="string">&quot;/&quot;</span> + gpRequestMapping.value()).replaceAll(<span class="string">&quot;/+&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">            handlerMapping.put(url, method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="doDispatch路由逻辑"><a href="#doDispatch路由逻辑" class="headerlink" title="doDispatch路由逻辑"></a>doDispatch路由逻辑</h4><p>请求路由逻辑，思路是这样的，拿到请求url，通过url找到初始化的method，这时候就有了目标类的执行方法。接下来就是填充请求参数，填充完后执行method.invoke方法执行目标类的方法，完成请求。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">    String url = req.getRequestURI();</span><br><span class="line">    String contextPath = req.getContextPath();</span><br><span class="line">    url = url.replace(contextPath, <span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;//+&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.handlerMapping.containsKey(url)) &#123;</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;404....!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//拿到url对应的controller请求方法</span></span><br><span class="line">    Method method = (Method) <span class="keyword">this</span>.handlerMapping.get(url);</span><br><span class="line">    <span class="comment">//请求传进来的实参</span></span><br><span class="line">    Map&lt;String, String[]&gt; parameterMap = req.getParameterMap();</span><br><span class="line">    <span class="comment">//取到形参类型</span></span><br><span class="line">    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line"><span class="comment">//实参数组初始化</span></span><br><span class="line">    Object[] paramValues = <span class="keyword">new</span> Object[parameterTypes.length];</span><br><span class="line"><span class="comment">//这里只处理String类型</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) &#123;</span><br><span class="line">        Class paramterType = parameterTypes[i];</span><br><span class="line">        <span class="keyword">if</span> (paramterType == HttpServletRequest.class) &#123;</span><br><span class="line">            paramValues[i] = req;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramterType == HttpServletResponse.class) &#123;</span><br><span class="line">            paramValues[i] = resp;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (paramterType == String.class) &#123;</span><br><span class="line">            Annotation[][] pa = method.getParameterAnnotations();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pa.length; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Annotation a : pa[i]) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (a <span class="keyword">instanceof</span> GPRequestParam) &#123;</span><br><span class="line">                        String paramName = ((GPRequestParam) a).value();</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(paramName.trim())) &#123;</span><br><span class="line">                            String value = Arrays.toString(parameterMap.get(paramName)).replaceAll(<span class="string">&quot;\\[|\\]&quot;</span>, <span class="string">&quot;&quot;</span>).replaceAll(<span class="string">&quot;\\s&quot;</span>, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">                            paramValues[i] = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String beanName = toLowerFirstCase(method.getDeclaringClass().getSimpleName());</span><br><span class="line">    method.invoke(<span class="keyword">this</span>.ioc.get(beanName), paramValues);</span><br><span class="line">    System.out.println(method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-0-MVC"><a href="#3-0-MVC" class="headerlink" title="3.0 MVC"></a>3.0 MVC</h3><p>待更</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;前言：&lt;/p&gt;
&lt;p&gt;　　最近打算提升下源码能力，跟着相关教程实现Spring框架，巩固下前面的学习知识，像反射、设计模式等，顺带熟悉一些API。像设计模式这类知识，只能通过代码实践来提升对其核心思想的理解，毕竟设计模式不是凭空产生的，而是在代码实</summary>
      
    
    
    
    <category term="web" scheme="https://dogfun.top/categories/web/"/>
    
    
    <category term="技术学习" scheme="https://dogfun.top/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/"/>
    
    <category term="Spring" scheme="https://dogfun.top/tags/Spring/"/>
    
    <category term="从零开始写框架" scheme="https://dogfun.top/tags/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E6%A1%86%E6%9E%B6/"/>
    
  </entry>
  
  <entry>
    <title>Nacos</title>
    <link href="https://dogfun.top/2020/09/25/%E4%B8%AD%E9%97%B4%E4%BB%B6/nacos/"/>
    <id>https://dogfun.top/2020/09/25/%E4%B8%AD%E9%97%B4%E4%BB%B6/nacos/</id>
    <published>2020-09-25T01:25:02.000Z</published>
    <updated>2021-11-28T03:34:17.993Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><h2 id="docker启动"><a href="#docker启动" class="headerlink" title="docker启动"></a>docker启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/nacos-group/nacos-docker.git</span><br><span class="line">cd nacos-docker</span><br><span class="line">docker-compose -f example/standalone-derby.yaml up</span><br></pre></td></tr></table></figure><h2 id="SpringCloud-namespaces"><a href="#SpringCloud-namespaces" class="headerlink" title="SpringCloud+namespaces"></a>SpringCloud+namespaces</h2><ol><li>添加命名空间</li><li>maven中定义多个环境profile</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">runtime.env</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">runtime.env</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nacos.server-addr</span>&gt;</span>10.91.22.7:8888<span class="tag">&lt;/<span class="name">nacos.server-addr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nacos.namespace</span>&gt;</span>aa96c495-c8fa-4078-b159-556c08592786<span class="tag">&lt;/<span class="name">nacos.namespace</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>local<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">runtime.env</span>&gt;</span>local<span class="tag">&lt;/<span class="name">runtime.env</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nacos.server-addr</span>&gt;</span>10.91.22.7:8888<span class="tag">&lt;/<span class="name">nacos.server-addr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nacos.namespace</span>&gt;</span>aa96c495-c8fa-4078-b159-556c08592786<span class="tag">&lt;/<span class="name">nacos.namespace</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>![image-20210512144727556](/Users/carytseng/Library/Application Support/typora-user-images/image-20210512144727556.png)</p><p><strong>maven中指定生效的profile，idea的active-profile指定的是项目下的对应环境的profile，非nacos上的配置</strong></p><ol start="3"><li>spring.cloud.nacos.discovery.namespace指定注册到相应的命名空间的注册列表，默认会在public</li></ol><p>![image-20210512144838409](/Users/carytseng/Library/Application Support/typora-user-images/image-20210512144838409.png)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Nacos&quot;&gt;&lt;a href=&quot;#Nacos&quot; class=&quot;headerlink&quot; title=&quot;Nacos&quot;&gt;&lt;/a&gt;Nacos&lt;/h1&gt;&lt;h2 id=&quot;docker启动&quot;&gt;&lt;a href=&quot;#docker启动&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="中间件" scheme="https://dogfun.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
</feed>
